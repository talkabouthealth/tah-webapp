#{ extends 'main.html' /}

	<style>
		#userpicture {
			float: left;
			margin: 10px;
		}
                .ui-dialog-title {
                    font-family: Verdana;
                    font-size: 12px;
                }
                .ui-dialog-titlebar-close {
                    display: none;
                }
                .ui-dialog-content {
                    font-family: Verdana;
                    font-size: 10px;
                }
                .ui-dialog .ui-dialog-buttonpane {
                    padding:0.2em;
                }
                .ui-dialog .ui-dialog-buttonpane button {
                    padding: 0.1 em;
                    margin: 0.1em;
                }
                .ui-button-text {
                    font-family: Verdana;
                    font-size: 12px;
                }
	</style>
        <script type="text/javascript">  
        
	function ajaxFileUpload(value) {
            var framename = 'frame' + new Date().getTime();
            $('<iframe id='+ framename +' name=' + framename + ' src="" style="position:absolute; top:-9999px; left:-9999px"></iframe>').appendTo(document.body); 
            $('#submitAction').val(value);
            $('#uploadimageform').attr('target', framename);
            $('#uploadimageform').submit();
            $("#loading").show();
            $('#userpicture').hide();
            var curtime = new Date().getTime();
            if ($.browser.safari) {
                checkResponse(curtime);
            }
            else {
                setTimeout('checkResponse(' + curtime + ')', 1000);
            }
	}
        var checkResponse = function(time) {
            var listAction = #{jsAction @Profile.imageStatus() /}
            $.get(listAction(), function(data){
                if (data == 'incomplete') {
                    if (new Date().getTime() - time > 5000) {
                       $("#image_msg").html("Error Uploading File. Please try again."); 
                       $("#loading").hide();
                       $('#userpicture').show();
                       $('iframe').remove();
                       $('#image_msg').dialog("open");
                    }   
                    else {
                        setTimeout('checkResponse(' + time + ')', 1000);
                    }
                }
                else {
                    var msg;
                    if (data == 'error') {
                        $("#image_msg").html('<p>Error uploading file. Please make sure size of file is under 50KB and type of file is jpg, png, gif</p>');
                        
                    }
                    else {
                        $('#image_msg').html('<p>Picture uploaded successfully. It may take a couple of minutes to appear on all of the pages.</p>');
                        
                    }
                    var imageurl = '@{Image.show(userName)}';
                    imageurl+= '?' + new Date().getTime();    
                    $('#userpicture').attr("src", imageurl);
                    
                    $('#userpicture').load(function(){
                        $("#loading").hide();
                        $('#userpicture').show();
                        $('iframe').remove();
                        $('#image_msg').dialog("open");
                        
                        $('#userpicture').unbind();
                    });
               }
               
            }, "text");
        };
        $(window).load(function(){
            $("#image_msg").dialog({
            autoOpen: false, 
            modal: true, 
            resizable: false,
            draggable: false,
            title: 'Upload Status', 
            buttons:[
                {
                    text: "OK",
                    click:function(){
                        $(this).dialog("close");
                    }
                }
        ] });
        });
	</script>	
</head>
<body>
	#{include 'header.html' /}

	<div id="innerbanner"></div>
	<form id="uploadimageform" name="uploadimageform" enctype="multipart/form-data"
              action="@{Profile.uploadImage()}" method="POST">
	<div id="innermain">
		<div class="blacktext2" id="innerheading">Upload Picture</div>
		<div id="innermiddlearea">
			<div id="notifactionbox">
				<div class="notifactionboxtop"></div>
				<div class="notifactionboxmid">
                                    <img id="loading" src="/public/images/loading.gif" style="padding: 34px; float: left; margin: 10px; display:none;" />
                                    <img id="userpicture" src="@{Image.show(userName)}?${num}" width="100" height="100" /> 
                                     
                                    <h3>Actions:</h3>
                                    <input type="file" id="imageFile" name="imageFile" onchange="return ajaxFileUpload('Upload');" />
                                    <br/><br/>
                                    <input type="button" value="Remove current image" onclick="return ajaxFileUpload('Remove current image');" />
                                    <input type="hidden" id="submitAction" name="submitAction" />
				</div>
				<div class="notifactionboxbot"></div>
			</div>
		</div>
	</div>
           
	</form>
        
        <div id="image_msg">
            
        </div>
        
       