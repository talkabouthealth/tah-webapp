#{extends 'main.html' /}
	<style type="text/css">
		body { background:transparent url(/public/images/inner_bgmt.gif) repeat-x scroll center top; }
		
		#innermiddlearea { padding-top: 10px }
		.seeall { padding-top: 20px }
		
		.inline_form { display:none; }
	</style>
	
	<script type="text/javascript" src="/public/plugins/jquery.truncatable.js" ></script>
	<script type="text/javascript" src="/public/plugins/jquery.inline-edit.js" ></script>
	<script type="text/javascript">
		var username = "${talker.userName}";
		var levelOfRecognition = "${talker.levelOfRecognition}";

		var flagType = "convo";
		var flagConvoId = "";

		var titleLimit = 150;
		var feedsPerPage = ${logic.FeedsLogic.FEEDS_PER_PAGE};

		#{ oauthJavaScripts /}

		$(document).ready(function() {
			makeAutocomplete("#convoText", "convo");
			
			$(".followConvoLink").live('click', function() {
				var topicId = $(this).attr("rel");
				if ($(this).html().indexOf("Unfollow") != -1) {
					$(this).html("Follow");
				}
				else {
					$(this).html("Unfollow");
				}
				$.post("@{Conversations.follow()}", 
	  				{ topicId: topicId},
	  				function(data) {
	  					//...
	  				}
	  			);
	  			return false;
			});

			var showIMPopup = ${showIMPopup};
			//showIMPopup = true;
			if (showIMPopup) {
				var id = "#imDialog";
				showPopup(id, 350);
			}

			$('.window #saveIMBtn').click(function (e) {
				//Cancel the link behavior
				e.preventDefault();

				var imService = $("#imDialog input[checked=true]").val();
				var imUserName = $("#imUserName").val();

				if (imService.length == 0) {
					alert("Please choose IM Service");
					return;
				}

				if (imService === "Twitter") {
					$('#mask').hide();
					$('.window').hide();
					
					openTwitter();
				}
				else {
					if (imUserName.length == 0) {
						alert("Please enter correct IM Username");
						return;
					}
					
					$.post("@{Profile.addIMAccount()}", 
						{imUserName : imUserName, imService : imService},
						function(data) {
							if (data.indexOf("<tr>") == 0) {
								$("#imUserName").val("");

								$('#mask').hide();
								$('.window').hide();
							}
							else {
								alert(data);
							}
						}
					);
				}
			});	

			$('#saveConvoBtn').click(function (e) {
				//openChat(2);
				//return;
				
				var type = "QUESTION";
				if ($("#newConvoTypeConvo").attr("checked")) {
					type = "CONVERSATION";
				}
				var title = $("#newConvoTitle").val();
				var details = $("#newConvoDetails").val();
				if (details === 'This is the place to provide context or further details for your request.') {
					details = '';
				}
				//var topics = $("#newConvoTopics").val();
				var topics = '';

				if (title === "") {
					alert("Please input headline.");
					return false;
				}

				$.post("@{Conversations.create()}", 
	  				{ type: type, title: title, details: details, topics: topics},
	  				function(data) {
	  					if (type === "CONVERSATION") {
		  					$("#startTalkBtn").click(function() {
			  					openChat(data.tid);
			  					$.post("@{Conversations.start}", {topicId: data.id});
			  					hideAll();
		  					});
	  						$("#newTalkConfirm").show();
	  					}
	  					else {
	  						$("#questionLink").attr("href", data.url).html(data.url);
	  						$("#newQuestionConfirm").show();
	  					}
	  					$("#newConvoForm").hide();

	  					$("#convoText").val("");
	  					$("#newConvoTitle").val("");
	  					$("#newConvoDetails").val("This is the place to provide context or further details for your request.");
	  					//$("#newConvoTopics").val("");
	  				}
	  			);

	  			return false;
			});

			//if close button is clicked
			$('.window .close, .window .cancelLink').click(function (e) {
				//Cancel the link behavior
				e.preventDefault();
				hideAll();
			});		

			$(".startLink").click(function(e) {
				$("#newConvoForm").show();
				$("#newQuestionConfirm").hide();
				$("#newTalkConfirm").hide();
				$("#newConvoTitle").val($("#convoText").val());
				showPopup("#startDialog", 350);
			});

			$('.inline-edit').inlineEdit( { hover: ''} );

			//----- Topics autocomplete -----------
			function split( val ) {
				return val.split( /,\s*/ );
			}
			function extractLast( term ) {
				return split( term ).pop();
			}
			/*
			var cache = {};
			$( "#newConvoTopics" ).autocomplete({
				minLength: 1,
				source: function(request, response) {
					if ( request.term in cache ) {
						response( cache[ request.term ] );
						return;
					}
					
					$.ajax({
						url: "/search/ajaxTopicSearch",
						dataType: "json",
						data: request,
						success: function( data ) {
							cache[ request.term ] = data;
							response( data );
						}
					});
				},
				search: function() {
					// custom minLength
					var term = extractLast( this.value );
					if ( term.length < 1 ) {
						return false;
					}
				},
				focus: function() {
					// prevent value inserted on focus
					return false;
				},
				select: function( event, ui ) {
					var terms = split( this.value );
					// remove the current input
					terms.pop();
					// add the selected item
					terms.push( ui.item.value );
					// add placeholder to get the comma-and-space at the end
					terms.push( "" );
					this.value = terms.join( ", " );
					return false;
				}
			})
			.data( "autocomplete" )._renderItem = function( ul, item ) {
				return $( "<li></li>" )
					.data( "item.autocomplete", item )
					.append( "<a>" + item.label + "&nbsp;<span>" + item.type + "</span></a>" )
					.appendTo( ul );
			};
			*/

			$('.moretext').truncatable({ limit: 160, more: '... more', less: true, hideText: '' });
		});

		function loadMoreFeed(type) {
			var lastActionId = $("#"+type+"List").children().last().attr("id");

			//public static void conversationFeedAjax(String afterActionId) {
			$.get("@{Home.feedAjaxLoad()}", {afterActionId: lastActionId, feedType: type},
					function(data) {
						var feedSize = $(data).find(".joinpic").size();
						if (feedSize < feedsPerPage) {
							//no more feeds - hide 'More' link
							$("#"+type+"Btn").hide();
						}
						
						$(data).appendTo($("#"+type+"List"));
						
						$('.inline-edit').inlineEdit( { hover: ''} );
					}
				);
			
			return false;
		}

		//for comments/replies in feed
		function showReplyForm(commentId) {
			$("#reply"+commentId+" .inline_display").hide();
			$("#reply"+commentId+" .inline_form").show();
			$("#reply"+commentId).show();
			return false;
		}

		//saveProfileComment(String profileTalkerId, String parentId, String text)
   		function saveProfileComment(parentId) {
   	   		var commentText = $("#replytext"+parentId).val();
   			$("#replytext"+parentId).val("");

   			$.post("@{Actions.saveProfileComment2()}", 
  				{ parentId: parentId, text: commentText},
  				function(html) {
  	  				$("#firstcommentmessage").hide();
  					//put comment in the tree
  					if (parentId == '') {
  	  					//add as first element in the top
  						$(html).prependTo($(".commentsarea"));

  	  					//add inline edit for new comment
  						$('.inline-edit').inlineEdit( { hover: ''} );
  					}
  					else {
  						//add as last element in subtree
  						$("#reply"+parentId).before($(html));
  					}
  				}
  			);

   			
  			return false;
   		}
	</script>
		
<div id="managtopic1" style="background:url(/public/images/inner_bgmt.gif); background-repeat:repeat-x;">
  <div id="managtopic">
  	#{include 'header.html' /}
        <div id="innermiddlearea">
          <div id="mtcover">
            <div id="mtleft">
              <div class="mtcontent">
                <div id="targetedtherapy">
                  <div class="comh1">Ask a question or start a talk</div>
                  <div class="comborder"></div>
                </div>
                <div class="topipcWraper">
                  #{startConvoInput /}

                  <!--startsearchbox-->
                  <div class="topic">
                    <div class="newpage1">Live Community Talks (${liveConversations.size()})</div>
                    <!-- <a href="#"><img src="/public/images/refreshicon.jpg" alt="refresh" 
                    	border="0" style="float:left; padding-left:4px; padding-top:22px"  /></a> -->
                    #{if liveConversations?.size() > 5}
                    	<div class="seeall"><a href="#">See All</a></div>
                    #{/if}
                    <div class="topicborder"></div>
                    <!--mtinputbox-->
                    <div class="cb"></div>

                    <div class="newpageCover">
                   		#{list items: liveConversations, as: 'convo'}
<div class="joinbox">
	<div class="joinpic">
		<a href="@{ViewDispatcher.view(convo.talker.userName)}">
			<img src="@{Image.show(convo.talker.userName)}" width="48" height="48" border="0" />
		</a>
	</div>
	<div class="jointxtbox">
		<div class="jointextstop">
			<a href="${convo.mainURL}">${convo.topic}</a>
		</div>
		<div class="joinztextlink">
			<a href="#" class="followConvoLink" rel="${convo.id}">
				${talker.followingConvosList?.contains(convo.id) ? 'Unfollow' : 'Follow'}</a>&nbsp;| 
			<span>${convo.creationDate.since()}</span>
		</div>
		<div class="jointxtlink1">
			Conversation by 
			<a href="@{ViewDispatcher.view(convo.talker.userName)}" 
				class="blue13"><strong>${convo.talker.userName}</strong></a>
			<span class="blacktext12">
				#{if convo.talker.connection}
					(${convo.talker.connection}, ${convo.talker.levelOfRecognition})
				#{/if}
				#{else}
					(${convo.talker.levelOfRecognition})
				#{/else}
			</span>
		</div>
		<div class="jointxtlink2"></div>
	</div>
	<div class="joinconbox">
		<input type="submit" src="/public/images/joinconversation.jpg" 
			value=" " class="joinconversation" onclick="return openChat('${convo.tid}');" />
	</div>
	<div class="cb"></div>
	<div class="joinborder"></div>
</div>		                      
						#{/list}
						#{else}
							<a href="#" class="startLink" style="font-size: 16px;">Be the first to start a live talk.</a>
						#{/else}
                      <!--joinbox-->
                      
                      <div class="topic">
                        <div class="newpage1">Your Conversation Feed</div>
                        <div class="topicborder"></div>
                        <div class="cb"></div>
                      </div>
                      <div class="topic">
                        <div id="convoFeedList">
	                    	#{list items: convoFeed, as: 'activity'}
								#{feedActivity activity: activity, talker: talker /}
							#{/list}
							#{else}
								<span class="blacktext16">When you Follow Topics, Conversations, and
									other members, your Conversation Feed will be filled with their updates.</span>
							#{/else}
						</div>
						#{if convoFeed.size() == logic.FeedsLogic.FEEDS_PER_PAGE }
							<div class="replytommentbox" id="convoFeedBtn">
	                          <input type="submit" src="images/seemore.jpg" 
	                          	onclick="return loadMoreFeed('convoFeed');" value=" " class="seemorecom" />
	                        </div>
						#{/if}
                        <div class="cb"></div>
                      </div>
                      
                      #{if communityFeed}
                      	<div class="topic">
	                        <div class="newpage1">Community Conversation Feed</div>
	                        <div class="topicborder"></div>
	                        <div class="cb"></div>
	                      </div>
	                      <div class="topic">
	                        <div id="communityFeedList">
		                    	#{list items: communityFeed, as: 'activity'}
									#{feedActivity activity: activity, talker: talker /}
								#{/list}
							</div>
							#{if communityFeed.size() == logic.FeedsLogic.FEEDS_PER_PAGE }
								<div class="replytommentbox" id="communityFeedBtn">
		                          <input type="submit" src="images/seemore.jpg" 
		                          	onclick="return loadMoreFeed('communityFeed');" value=" " class="seemorecom" />
		                        </div>
							#{/if}
	                        <div class="cb"></div>
	                      </div>
                      #{/if}
                      <!--topic-->
                      <div class="cb"></div>
                    </div>
                    <!--newpageCover-->
                    <div class="cb"></div>
                  </div>
                  <!--topic-->
                  <div class="cb"></div>
                </div>
                <!--topipcWraper-->
                <div class="cb"></div>
              </div>
              <!--mtcontent-->
              <div class="cb"></div>
            </div>
            <!--mtleft-->
            
            #{ set currentPage = 'home' /}
            #{ include 'right.html' /}
            
            <!--mtright-->
            <div class="cb"></div>
          </div>
          <!--mtcover-->
          <div class="cb"></div>

        </div>
        <div id="signupright"></div>
      </div>
    </div>
  </div>


<div id="boxes">
  <div id="dialog" class="window"> </div>
  
  #{popups/startConvo /}
  
  <div id="imDialog" class="window">
	<div id="innermiddlearea">
		<div class="popboxWraper">
			<div class="popbox">
				<div class="closecover">
            		<div class="close">
            			<img src="/public/images/close.jpg" alt="Close" onmouseover="this.style.cursor='pointer'"/>
            		</div>
            	</div>
				<div class="tah">
					<img src="/public/images/talkabouthealth.jpg" alt="TalkAboutHealth" 
						onmouseover="this.style.cursor='pointer'"/>
				</div>
            	<div class="imheading">Please provide your Instant Message or Twitter account.</div>
            	<div class="opheading">This is optional. TalkAboutHealth notifies you of conversations and questions
 					relevant to you via instant message or Twitter.</div>
 				<div class="selheading">Select a Service:</div>
 		
 		#{list items: models.IMAccountBean.IM_SERVICES_MAP.keySet(), as:'imService'}
		    <div class="poptxtCover">
	        	<div class="popradio">
	        		<input name="imService" value="${imService}" 
	        			#{if "GoogleTalk".equals(imService) } checked="true" #{/if}
	        			type="radio" />
	        	</div>
	        	<div class="poptext">${models.IMAccountBean.IM_SERVICES_MAP.get(imService)}</div>
	        </div>
		#{/list}
		<div class="poptxtCover">
        	<div class="popradio">
        		<input name="imService" value="Twitter" type="radio" />
        	</div>
        	<div class="poptext">Twitter</div>
        </div>
        
        <div class="popuser">
        <div class="popusertxzt">Username:</div>
        <div class="popuserinput"><input id="imUserName" type="text" class="popinput" /></div>
        </div><!--popuser-->
        <div class="popusertxt1">Just the username (i.e. janesmith), no need for the @gmail.com or @yahoo.com  </div><!--popusertxt1-->
        <div class="popsubmitcover">
        <div class="popsubmitbox">
        	<input type="submit" id="saveIMBtn" src="/public/images/popsubmit.jpg" value=" " class="popsubmit" 
        		onmouseover="this.style.cursor='pointer'"/>
        </div>
        <div class="popnothanks" ><a href="#" onclick="return hideAll();">No thanks</a></div>
        </div><!--popsubmitcover-->
            <div class="cb"></div>
            </div>
            <!--popbox-->
            </div><!--popboxWraper-->
           
            <div class="cb"></div>
          </div>
	</div>
	
  <!-- Mask to cover the whole screen -->
  <div id="mask"></div>
</div>