#{set pageType = 'Conversation' /}
#{set pageTitle = convo.topic /}
#{set pageDescription = convo.pageDescription /}
#{set pageKeywords = convo.pageKeywords /}
#{extends 'main.html' /}
<link href="/public/stylesheets/viewconvo.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/public/plugins/jquery.inline-edit.js" ></script>
<script type="text/javascript" src="/public/javascripts/viewconvo.js" ></script>
<script type="text/javascript">
		var tid = "${convo.tid}";
		var currentConvoId = "${convo.id}";
		$(document).ready(function() {
			var share = "${params.share}";
			$("#followConvoBtn").click(function() {
				var moreBtn = this;
				$("#ajaxLoading").appendTo(moreBtn.parentNode).show();
				moreBtn.style.display='none';
				$.post("@{Conversations.follow()}",  { convoId: '${convo.id}'},
	  				function(nextAction) {
		  				if (nextAction === "follow") {
		  					$("#followConvoBtn").removeClass().addClass("followConvoBtn");
		  					$("#ajaxLoading").hide();
		  					$("#followConvoBtn").show();
		  				} else {
		  					$("#followConvoBtn").removeClass().addClass("followingConvoBtn");
		  					$("#ajaxLoading").hide();
		  					$("#followConvoBtn").show();
		  				}
	  				}
	  			);
			});
			$(".votebtnup, .votebtndown").live("click", function() { //Vote Up/Vote Down handler
   				var value = $(this).hasClass("votebtnup") ? true : false;
   				var answerId = $(this).attr("rel");
   				$.post("@{Conversations.vote}", 
   		   				{ answerId : answerId, up : value },
   		   				function(data) {
	   		   				if (data !== "Error") {
		   		   				if (value) {
		   			   				$("#vote"+answerId+" .votebtnup").addClass("selected");
		   			   				$("#vote"+answerId+" .votebtndown").removeClass("selected");
		   		   				}
		   		   				else {
		   		   					$("#vote"+answerId+" .votebtnup").removeClass("selected");
		   			   				$("#vote"+answerId+" .votebtndown").addClass("selected");
		   		   				}
		   		   				$("#comment"+answerId+" .votestxt3").html(data);
	   		   				}
   		   				}
	   				);
   				return false;
   			}); 
			
				//Delete topic from topics (tags)
   			$(".deleteTopicLink").live("click", function() {
   	   			$(this).prev().remove();
   	   			var topicId = $(this).attr("rel");
   	   			$(this).remove();

   	   			$.post("@{Conversations.updateField()}", 
	   					{ convoId : '${convo.id}', name: 'topic', value: topicId, todo: 'remove'},
	   					function() {
	   						$("#topicsList").html($("#topicsEditList").html());
	   					}
	   				);

   	   			return false;
   			});

   			//Delete disease from other diseases
   			$(".deleteDiseaseLink").live("click", function() {
   	   			$(this).prev().remove();
   	   			var disease = $(this).attr("rel");
   	   			$(this).remove();
   	   			$.post("@{Conversations.updateField()}", 
	   					{ convoId : '${convo.id}', name: 'disease', value: disease, todo: 'remove'},
	   					function() {
	   						$("#diseasesList").html($("#diseasesEditList").html());
	   					}
	   				);
   	   			return false;
   			});
			//Delete conversation from Related/Follow-Up conversations
   			$(".deleteConvoLink").live("click", function() {
   				var deleteConvoId = $(this).attr("rel");
   	   			$(this).parent().remove();
   	   			var name = "";
   	   			if ($(this).hasClass("relatedConvos")) {
   	   				name = "relatedConvos";
   	   			} else {
   	   	   			name = "followupConvos";
   	   			}
   	   			$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: name, value: deleteConvoId, todo: 'remove'},
   					function(html) {
   						if (name === "relatedConvos") {
   							$("#relatedConvosList").html($("#relatedConvosEditList").html());
   		   	   			} else {
   		   	   				$("#followupConvosList").html($("#followupConvosEditList").html());
   		   	   			}
   					}
   				);
   				return false;
   			});
   			startWindow(share);
		});
		function mergeConvoOp(selectedConvoURL){
	   	  		$.post("@{Conversations.mergeConvos()}",{ convoId :'${convo.id}', convoToMergeURL : selectedConvoURL}, function(html) { window.location.reload(); });
		}
		function deleteLinkClickEvent(){
			$.post("@{Conversations.updateField()}", { convoId : '${convo.id}', name: 'topic', value: topicId, todo: 'remove'},function() { $("#topicsList").html($("#topicsEditList").html()); } );
		}
		/** Called after inline editing of title/details/summary/etc. */
		function saveData(dataType, newValue) {
			if (dataType === 'titleEdit') {
				$.post("@{Conversations.updateField()}", { convoId : '${convo.id}', name: 'title', value: newValue},function() {});
			} else if (dataType === 'detailsEdit') {
				$.post("@{Conversations.updateField()}", { convoId : '${convo.id}', name: 'details', value: newValue},function() {});
			} else if (dataType === 'summaryEdit') {
				$.post("@{Conversations.updateField()}", { convoId : '${convo.id}', name: 'summary', value: newValue},function() {});
			} else if (dataType.indexOf('answerEdit') == 0) {
				var answerId = dataType.substring(10);
	   	   		$.post("@{Conversations.updateAnswer()}",{ answerId: answerId, todo: 'update', newText: newValue},function(html) {});
			}
		}
		function updateData(dataType, newValue) {/** Called after editing lists - topics, related/follow-up conversations */
			if (dataType === 'relatedConvosEdit') {
				$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'relatedConvos', value: newValue, todo: 'add'},
   					function(html) {
   	   					$(html).appendTo($("#relatedConvosEditList"));
   	   					$("#relatedConvosList").html($("#relatedConvosEditList").html());
   					}
   				);
			} else if (dataType === 'followupConvosEdit') {
				$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'followupConvos', value: newValue, todo: 'add'},
   					function(html) {
   	   					$(html).appendTo($("#followupConvosEditList"));
   	   					$("#followupConvosList").html($("#followupConvosEditList").html());
   					}
   				);
			} else if (dataType === 'topicsEdit') { //possible comma-separated topics
				$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'topic', value: newValue, todo: 'add'},
   					function(html) {
   						$(html).appendTo($("#topicsEditList"));
   	   					$("#topicsList").html($("#topicsEditList").html());
   					}
   				);
			} else if (dataType === 'diseaseEdit') { //possible comma-separated diseases
				$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'disease', value: newValue, todo: 'add'},
   					function(html) {
   						$(html).appendTo($("#diseasesEditList"));
   	   					$("#diseasesList").html($("#diseasesEditList").html());
   					}
   				);
			}
		} //public static void saveAnswerOrReply(String topicId, String parentId, String text) {
   		function saveAnswerOrReply(parentId) {
   	   		var commentText = $("#replytext"+parentId).val();
   			$("#replytext"+parentId).val("");
   			$("#saveAnswerImage"+parentId).show();
   			$.post("@{Conversations.saveAnswerOrReply()}", 
  				{ convoId: '${convo.id}', parentId: parentId, text: commentText},
  				function(html) {
  					$("#replyform"+parentId).before($(html));
  					$("#saveAnswerImage"+parentId).hide();//user can post only one answer per convo
  					if (parentId === '') {
  						$("#answerBtn").hide();
  	  					$("#answerFormDiv").hide();
  	  					$("#noAnswerText").show();
  					}
  					$('.inline-edit').inlineEdit({ hover: '', saveFunction: saveData, updateFunction: updateData});
  				}
  			);
  			return false;
   		}
   		function saveAnswer(parentId) {
   	   		var commentText = $("#replytextPopup"+parentId).val();
   			$("#saveAnswerImagePopup"+parentId).show();
   			$.post("@{Conversations.saveAnswerOrReply()}", { convoId: '${convo.id}', parentId: parentId, text: commentText},
  				function(html) {
  					hideAll();
  					$("#replyform"+parentId).before($(html));
  					$("#saveAnswerImagePopup"+parentId).hide();//user can post only one answer per convo
  					if (parentId === '') {
  						$("#answerBtn").hide();	$("#answerFormDiv").hide();	$("#noAnswerText").show();
  					}
  					$('.inline-edit').inlineEdit( { hover: '', saveFunction: saveData, updateFunction: updateData} );
  				}
  			);
  			return false;
   		}
   		undeleteAnswerMain = function(answerId){
   			$.post("@{Conversations.updateAnswer()}",{ answerId: answerId, todo: 'undelete', newText: ''},function(html) { window.location.reload(true); });
		}
   		function deleteAnswerMain(answerId) {
   			$.post("@{Conversations.updateAnswer()}", { answerId: answerId, todo: 'delete', newText: ''},function(html) { window.location.reload(true); });
   		}
   		function markNotHelpfulMain(answerId) {
   			$.post("@{Conversations.updateAnswer()}", { answerId: answerId, todo: 'setNotHelpful', newText: ''},function(html) { });
   		}
   		function deleteConvoMain() {
   			$.post("@{Conversations.delete()}", { convoId : '${convo.id}'}, function (html) { document.location = "/home"; } );
   		}		//------------ Convo replies ---------------
   		function saveConvoReply() {
   	   		var replyText = $("#convoReplyText").val();
   	   		$("#convoReplyText").val("");
   			$("#saveConvoReplyImage").show();
			$.post("@{Conversations.saveConvoReply()}", 
			{ convoId: '${convo.id}', text: replyText},
				function(html) {
				$("#convoReplyForm").before($(html));
				$("#saveConvoReplyImage").hide();
				$('.inline-edit').inlineEdit({ hover: '', saveFunction: saveData, updateFunction: updateData});
			}
		);
		return false;
	}
	function deleteChatMessageMain(index) {//used by admin
		$.post("@{Conversations.deleteChatMessage()}",{ convoId : '${convo.id}', index: index},function (html) { });
	}
	</script>
</head>
<body>
<div id="managtopic1">
	#{include 'header.html' /}
	<div id="bottom_container">
      	<div class="haderbanner"><div id="innerbanner"></div></div>
	<div id="targetedtherapy">
		<div id="innermiddlearea">
			<div id="mtcover">
				<div id="mtleft">
					<div class="mtcontent">
						<div id="targetedtherapy">
							<div class="suggescover">
								#{include '/Conversations/viewConvoPart1.html' /}	
	
							</div><!--suggescover-->
            			</div> <!--targetedtherapy-->
            		
						<div class="cb"></div>
					</div><!--mtcontent-->
          		</div>
				<div id="mtright1" style="padding-top: 10px">
					#{if talker }
					<div width=100%>
						#{if talker.followingConvosList?.contains(convo.id) }
							<a href="#" id="followConvoBtn" class="followingConvoBtn"></a>
							<a href="#" id="answerBtn" class="answerBtn" onclick="addAnswer();" style="display: ${userHasAnswer ? 'none' : 'block'};"></a>
						#{/if}
						#{else}
							<a href="#" id="followConvoBtn" class="followConvoBtn"></a>
							<a href="#" id="answerBtn" class="answerBtn" onclick="addAnswer();" style="display: ${userHasAnswer ? 'none' : 'block'};"></a>
						#{/else}
					</div>
						<div class="cb"></div>
				    	<div class="topicborder" style="margin-top: 10px;"></div>
					#{/if}
					#{else}
						#{include 'tahInfo.html' /}
					#{/else}
					<div class="topipsts">
						<div class="Statics">
							<div class="Staticsh1">Question Statistics</div>
							<p style="color:#000000">
								<strong>Latest Activity:</strong> ${latestActivityTime?.format('MM / dd / yyyy')} <br />
								<strong>Views:</strong> ${convo.views}<br />
								<strong>Followed By:</strong> ${convo.followers?.size()} members<br/>
								#{if talker}
									#{list items: convo.followers, as: 'follower'}
										#{talker/talkerImageLink size: 48, userName: follower.userName /}
									#{/list}
								#{/if}
							</p><br />
							<div class="topicborder"></div>
						</div>
						<div class="cb"></div>
					</div><!--topipsts-->
					#{if relatedConvo && relatedConvo.size() > 0}
					<div class="topipsts">
						<div class='inline-edit' id="relatedConvosEdit" style="padding-bottom: 3px;">
							<div class="inline_display">
								<div class="Staticsh1" style="float:left; padding:10px 0 0 0;">Similar Questions</div>
								<div class="inline_full" style="display: ${(convo.relatedConvos || relatedConvos) ? 'block' : 'none'}">
									#{if talker && (talker.admin || talker.userName == convo.talker.userName) }
										<div class="editdiv">
											<div class="editit" style="padding-top:10px;">
												<a href="#" class="inline_editlink">Edit</a>
											</div>
										</div>
									#{/if}
									<div id="relatedConvosList">
										#{list items: convo.relatedConvos, as: 'relatedConvo'}
											<p class="rcpadtop">
												#{if relatedConvo}
												<a href="${relatedConvo.mainURL}">${relatedConvo.topic}</a>
												#{/if}
					                		</p>
										#{/list}
									</div>
									
									%{int i=0;}%
									#{list items: relatedConvos, as: 'relatedConvo'}
										
										#{if relatedConvo && i<8 }
										<p class="rcpadtop">
											<a href="${relatedConvo.mainURL}">${relatedConvo.topic}</a>
											%{i++;}%
												</p>
										#{/if}
				                	
									#{/list}
								</div>
								<div class="inline_empty" style="display: ${!(convo.relatedConvos || relatedConvos) ? 'block' : 'none'}">
									#{if talker }
										<div class="targetenew">
											<a class="inline_addlink" href="#">Add a new similar question</a>
										</div>
									#{/if}
								</div>
				            </div>
				           
							<div class='inline_form'>
								<div class="Staticsh1" style="float:left; padding:10px 0 0 0;">Similar Questions</div>
								<div style="float:left; font-size: 14px;">Add a similar question</div>
								<div id="relatedConvosEditList">
									#{list items: convo.relatedConvos, as: 'relatedConvo'}
										<p class="rcpadtop">
										#{if relatedConvo}
											<a href="${relatedConvo.mainURL}">${relatedConvo.topic}</a>&nbsp;
											<a class="deleteConvoLink relatedConvos" href="#" rel="${relatedConvo.id}">X</a>
											#{/if}
				                		</p>
									#{/list}
								</div>
								<div style="float: left; padding-top:10px;">
							        <input type="text" id="relatedConvosInput" class="edititinputx inline_text" 
							        	style="width:200px; height: 22px;" value="" />
						        </div>
								<div style="float:left; width: 205px; padding-top: 5px; text-align: right;">
									<a href="#" class="cancel">Done</a>
									<input type="submit" class="inline_add" 
										value="Add" style="margin-left: 7px;" />
								</div>
							</div>
						</div>
						<div class="topicborder"></div>
						<div class="cb"></div>
					</div><!--topipsts-->
					 #{/if}
					#{if convo.followupConvos != null && convo.followupConvos.size() > 0}
					<div class="topipsts">
						<div class="inline-edit" id="followupConvosEdit" style="padding-bottom: 3px;">
							<div class="inline_display">
								<div class="Staticsh1" style="float:left; padding:10px 0 0 0;">Follow-up Questions</div>
								<div class="inline_full" style="display: ${convo.followupConvos ? 'block' : 'none'}">
									#{if talker }
										<div class="editdiv">
											<div class="editit" style="padding-top:10px;"> <a href="#" class="inline_editlink">Edit</a> </div>
										</div>
									#{/if}
									<div id="followupConvosList">
										#{list items: convo.followupConvos, as: 'followupConvo'}
											<p class="rcpadtop"> <a href="${followupConvo.mainURL}">${followupConvo.topic}</a> </p>
										#{/list}
									</div>
								</div>
								<div class="inline_empty" style="display: ${!convo.followupConvos ? 'block' : 'none'}">
									#{if talker }
										<div class="targetenew"> <a class="inline_addlink" href="#">Add a new follow up question</a> </div>
									#{/if}
								</div>
				            </div>
							<div class='inline_form'>
								<div class="Staticsh1" style="float:left; padding:10px 0 0 0;">Follow-up Questions</div>
								<div style="float:left; font-size: 14px;">Add a follow up question</div>
								<div id="followupConvosEditList">
									#{list items: convo.followupConvos, as: 'followupConvo'}
										<p class="rcpadtop">
											<a href="${followupConvo.mainURL}">${followupConvo.topic}</a>&nbsp;
											<a class="deleteConvoLink" href="#" rel="${followupConvo.id}">X</a>
				                		</p>
									#{/list}
								</div>
								<div style="float: left; padding-top:10px;">
							        <input type="text" id="followupConvosInput" class="edititinputx inline_text" 
							        	style="width:200px; height: 22px;" value="" />
						        </div>
								<div style="float:left; width: 205px; padding-top: 5px; text-align: right;">
									<a href="#" class="cancel">Done</a>
									<input type="submit" class="inline_add" 
										value="Add" style="margin-left: 7px;" />
								</div>
							</div>
						</div>
						<div class="topicborder"></div>
						<div class="cb"></div>
					</div><!--topipsts-->
					#{/if}
					#{include 'Upcoming_Workshops.html' /}
					#{common/popularTopics popularTopics: popularTopics /}
					#{include 'SHARE_telephone_support.html' /}
					#{include 'tahHowYouCanHelp.html' /}
					#{include 'shareWidgets.html' /}
		            <div class="cb"></div>
				</div>
          		<div class="cb"></div>
          </div><!--mtcover-->
           <div class="cb"></div>
	</div>
</div>
</div>
</div>
<div id="mask"></div>
