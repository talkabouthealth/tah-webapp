#{extends 'main.html' /}
	<style>
		body {
			background:url(/public/images/inner_bgmt.gif) repeat-x top;
			font-size: 14px;
		}
		#innermiddlearea { padding-top: 10px }
		
		a {color:#1a6a96; text-decoration:none}
		a:hover {color:#ccc; text-decoration:none}
		.style2 {color: #000000}
		.display {
			background:#FFF;
			width:1px;
			height:1px;
			margin-left:3px;
		}
		li { list-style:none; }
		caption, th { text-align:left; }
		
		/* Different fixes */
		.answerCover { padding-top: 0px }
		.targetenew a { color:#0D94D6; }
		.inline_form {
			display:none;
		}
		.inline-edit .editdiv {
			float:left;
			width:45px;
			margin-left: 3px;
		}
		
		#relatedConvosList .deleteConvoLink {
			display: none;
		}
		.topicTitle { margin-left: 10px; }
		.deleteTopicLink { margin-right: 10px }
		#topicsList, #topicsEditList { float: left }
		#topicsList .deleteTopicLink {
			display: none;
		}
		
		.rcpadtop { width:260px; }
		
		h1 {
			color:#000000;
			font-family:arial;
			font-size:20px;
			text-decoration:none;
		}
		
		/* for popups */
		.popboxflagzx { top: 0px; left: 0px }
	</style>

	<script type="text/javascript" src="/public/plugins/jquery.inline-edit.js" ></script>
	<script type="text/javascript">
		var tid = '${convo.tid}';
		
		var flagType = '';
		var flagAnswerId = '';

		var selectedTalkerId = '';

		var titleLimit = 150;
		
		$(document).ready(function() {
			$("#followConvoLink").click(function() {
				$.post("@{Conversations.follow()}", 
	  				{ topicId: '${convo.id}'},
	  				function(nextAction) {
	  					var linkDiv = $("#followConvoLink").children().first();
	  					linkDiv.removeClass();
		  				if (nextAction === "follow") {
		  					linkDiv.addClass("followcn");
		  				}
		  				else {
		  					linkDiv.addClass("followcnzz");
		  				}
	  				}
	  			);
			});

			$(".restartConvoLink").click(function() {
				openChat(tid);
				$.post("@{Conversations.restart}", {topicId: '${convo.id}'});
			});

			$(".flagConvoLink").click(function() {
				flagType = "convo";
				showPopup("#flagPopup");
			});

			//----- Comments ------
			$(".votebtn").live("click", function() {
	   				var value = $(this).attr("title") === "up" ? true : false;
	   				var answerId = $(this).attr("rel");

	   				$.post("@{Conversations.vote}", 
	   		   				{ answerId : answerId, up : value },
	   		   				function(data) {
		   		   				if (data !== "ok") {
			   		   				alert(data);
		   		   				}
	   		   				}
		   				);

	   				return false;
	   			});
   			
			$(".flagAnswerLink").live("click", function() {
				flagType = "answer";
				flagAnswerId = $(this).attr("rel");
				showPopup("#flagPopup");
			});

   			$(".deleteTopicLink").live("click", function() {
   	   			$(this).prev().remove();
   	   			var topicId = $(this).attr("rel");
   	   			$(this).remove();

   	   			$.post("@{Conversations.updateField()}", 
	   					{ convoId : '${convo.id}', name: 'topic', value: topicId, todo: 'remove'},
	   					function() {
	   						$("#topicsList").html($("#topicsEditList").html());
	   					}
	   				);

   	   			return false;
   			});

   			$(".deleteConvoLink").live("click", function() {
   				var relatedConvoId = $(this).attr("rel");
   	   			$(this).parent().remove();

   	   			$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'relatedConvos', value: relatedConvoId, todo: 'remove'},
   					function(html) {
   	   					$("#relatedConvosList").html($("#relatedConvosEditList").html());
   					}
   				);
   				
   				return false;
   			});

   			$('.inline-edit').inlineEdit(
		  		{ hover: '', saveFunction: saveData, updateFunction: updateData}
		  	);

   			makeAutocomplete("#topicInput", "topic");
   			makeAutocomplete("#relatedConvosInput", "convo");
		});

		function saveData(dataType, newValue) {
			if (dataType === 'titleEdit') {
				$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'title', value: newValue},
   					function() {
   	   					//good save!!
   					}
   				);
			}
			else if (dataType === 'detailsEdit') {
				$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'details', value: newValue},
   					function() {
   	   					//good save!!
   					}
   				);
			}
			else if (dataType === 'summaryEdit') {
				$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'summary', value: newValue},
   					function() {
   	   					//good save!!
   					}
   				);
			}
			else if (dataType.indexOf('answerEdit') == 0) {
				var answerId = dataType.substring(10);
				
	   	   		$.post("@{Conversations.updateAnswer()}", 
	  				{ answerId: answerId, todo: 'update', newText: newValue},
	  				function(html) {
	  	  				//...
	  				}
	  			);
			}
		}

		function updateData(dataType, newValue) {
			if (dataType === 'relatedConvosEdit') {
				$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'relatedConvos', value: newValue, todo: 'add'},
   					function(html) {
   	   					$(html).appendTo($("#relatedConvosEditList"));

   	   					$("#relatedConvosList").html($("#relatedConvosEditList").html());
   					}
   				);
			}
			else if (dataType === 'topicsEdit') {
				$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'topic', value: newValue, todo: 'add'},
   					function(html) {
   						$(html).appendTo($("#topicsEditList"));

   	   					$("#topicsList").html($("#topicsEditList").html());
   					}
   				);
			}
		}

   		//public static void saveTopicComment(String topicId, String parentId, String text) {
   		function saveProfileComment(parentId) {
   	   		var commentText = $("#replytext"+parentId).val();
   			$("#replytext"+parentId).val("");

   			$.post("@{Conversations.saveTopicComment()}", 
  				{ topicId: '${convo.id}', parentId: parentId, text: commentText},
  				function(html) {
  	  				$("#firstcommentmessage").hide();
  					$("#replyform"+parentId).before($(html));
  				}
  			);

  			return false;
   		}

   		function deleteAnswer(answerId) {
   	   		var confirmDel = confirm("Are you sure want to delete this answer?");
   	   		if (confirmDel) {
   	   	   		$("#comment"+answerId).remove();

   	   	  	$.post("@{Conversations.updateAnswer()}", 
    				{ answerId: answerId, todo: 'delete', newText: ''},
    				function(html) {
    	  				//...
    				}
    			);
   	   		}
   	   		return false;
   		}

   		function markNotHelpful(answerId) {
   	   		var confirmDel = confirm("Are you sure want to mark as 'Not Helpful' this answer?");
   	   		if (confirmDel) {
   	   	   		//$("#comment"+answerId).hide();

   	   	  		$.post("@{Conversations.updateAnswer()}", 
    				{ answerId: answerId, todo: 'setNotHelpful', newText: ''},
    				function(html) {
    	  				//...
    				}
    			);
   	   		}
   	   		return false;
   		}

   		function deleteConvo() {
   	   		var confirmDel = confirm("Are you sure want to delete this conversation?");
   	   		if (confirmDel) {
   	   	  		$.post("@{Conversations.delete()}", 
    				{ convoId : '${convo.id}'},
    				function (html) {
    					document.location = "/home";
    				}
    			);
   	   		}
   	   		
   	   		return false;
   		}

   		function thankYou(talkerId, userName) {
   			$("#thankYouUser").html(userName);
   			selectedTalkerId = talkerId;
   			
			showPopup("#thankYouPopup");
			return false;
   		}

   		function saveThankYou() {
   			var noteText = $("#thankYouListNote").val();
   			hideAll();
   			$("#thankYouListNote").val("");

   			$.post("/actions/createThankYou", 
   				{ toTalker: selectedTalkerId, note: noteText}
   			);
   			return false;
   		}

   		//flag convo or answer
   		function flag() {
   	   		var reason = $("#flagReason").val();
   	   		$("#flagReason").val("");
   			if (flagType === "convo") {
				$.post("@{Conversations.flag}", 
						{reason: reason, convoId: '${convo.id}'}
				);
			}
   			else if (flagType === "answer") {
   				$.post("@{Conversations.flagAnswer}", 
					{reason: reason, answerId: flagAnswerId}
				);
   			}

   			hideAll();
   			return false;
   		}
	</script>
</head>

<body>
<div id="managtopic1" style="background:url(/public/images/inner_bgmt.gif); background-repeat:repeat-x;">
<div id="managtopic">

	#{include 'header.html' /}

	<div id="targetedtherapy">
		<div id="innermiddlearea">
			<div id="mtcover">
				<div id="mtleft">
					<div class="mtcontent">
						<div id="targetedtherapy">
							<div class="suggescover">
								<div class="editsWraper">
									<div class="editsWraper">
										<div class='inline-edit' id="titleEdit">
											<div class="inline_display">
												<div class="inline_full">
													<div class="targetedh7">
														<h1 class="inline_view">${convo.topic}</h1>
													</div>
													<div class="editdiv">
														<div class="editit">
															<a href="#" class="inline_editlink">Edit</a>
														</div>
													</div>
												</div>
												<div class="inline_empty" style="display: none">
													<div class="targetenew">
														<a class="inline_addlink" href="#">Add title..</a>
													</div>
												</div>
								            </div>
											<div class='inline_form'>
												<div style="float:left; width:auto; padding-bottom:5px;" >
										        	<input id="titleinput" type="text" style="width:600px"  
										        		value="${convo.topic}" class="edititinputs inline_text notempty" 
										        		onKeyDown="limitText(this, titleLimit);" onKeyUp="limitText(this, titleLimit);" >
										        </div>
												<div style="float:right;margin-right:30px;">
											        <input id="titleBtn" type="submit" class="updatebtns inline_save" value=" " />
											        <div class="canclebtnz">
											        	<a class="cancel" href="#">Cancel</a>
											        </div>
												</div>
											</div>
										</div>
									</div>
								</div><!--editsWraper-->
								<div style="clear:both">
									<div class='inline-edit' id="detailsEdit">
										<div class="suggestxt inline_display">
											<div class="inline_full" style="display: ${convo.details ? 'block' : 'none'}">
												<p style="float:left; padding-top:10px;" class="inline_view">${convo.details}</p>
												<div class="editdiv">
													<div class="editit" style="padding-top:10px;">
														<a href="#" class="inline_editlink">Edit</a>
													</div>
												</div>
											</div>
											<div class="inline_empty" style="display: ${!convo.details ? 'block' : 'none'}">
												<div class="targetenew">
													<a class="inline_addlink" href="#">Add Conversation Details</a>
												</div>
											</div>
							            </div>
										<div class='inline_form'>
											<div style="padding-top:10px;">
										        <textarea id="detailsinput" class="edititinputx inline_text" 
										        	style="width:600px">${convo.details}</textarea>
									        </div>
											<div style="float:right;margin-right:30px;">
												<input id="detailsBtn" type="submit" class="updatebtns inline_save" value=" " />
												<div class="canclebtnz">
													<a class="cancel" href="#">Cancel</a>
												</div>
											</div>
										</div>
									</div>
								</div> <!--Blank-->   
							</div><!--suggescover-->
                  		</div> <!--targetedtherapy-->
                  		<div class="topipcWraper">
                    		<div class="topic">
                    		
								<div class='inline-edit' id="topicsEdit">
									<div class="suggestxt inline_display">
										<div class="inline_full" style="display: ${convo.topics ? 'block' : 'none'}">
											<div style="display: block; float: left; width: auto;" class="topictxt">
                        						<div style="float: left;">Topics: </div>
                        						<div id="topicsList">
	                        						#{list items: convo.topics, as: 'tag'}
														<a class="topicTitle" href="@{ViewDispatcher.view(tag.mainURL)}">${tag.title}</a>
													#{/list}
                        						</div>
											</div>
											<div class="editdiv">
												<div class="editit" style="padding-top:10px;">
													<a href="#" class="inline_editlink">Edit</a>
												</div>
											</div>
										</div>
										<div class="inline_empty" style="display: ${!convo.topics ? 'block' : 'none'}">
											<div class="targetenew">
												<a class="inline_addlink" href="#">Add Topics</a>
											</div>
										</div>
						            </div>
									<div class='inline_form'>
										<div style="display: block; float: left; width: auto;" class="topictxt">
                       						<div style="float: left;">Topics: </div>
                       						<div id="topicsEditList">
                        						#{list items: convo.topics, as: 'tag'}
													<a class="topicTitle" href="@{ViewDispatcher.view(tag.mainURL)}">${tag.title}</a>
													<a class="deleteTopicLink" href="#" rel="${tag.id}">X</a>
												#{/list}
                       						</div>
										</div>
										<div class="addcomCover" style="width:400px;">
											<input type="text" id="topicInput" 
												class="addcominput inline_text"  value="" style="float:left; width:215px;"/>
						                   	<input type="submit" value=" " id="addTopicBtn" 
						                   		class="addcomsubmit inline_add" style="float:left; width:80;"  />
									        <div class="canclebtnz" style="float:left; width:auto;">
									          	<a class="cancel" href="#">Cancel</a>
									        </div> 
									    </div>
									</div>
								</div>
                      
                      			#{if talker }
									<div class="tagtxts">
				                    	<a href="#" class="restartConvoLink">Restart Conversation</a> |  
				                    	<!-- <a href="#">Start Follow up conversation</a>  |  -->  
				                    	<a href="#" class="flagConvoLink">Flag Question</a> 
				                    	#{if session.username?.equals("admin") || convo.talker.userName.equals(session.username)}
				                        	  |  <a href="#" onclick="return deleteConvo();">Delete</a> 
				                        #{/if}
				                    </div>
								#{/if}
								<div class="cb"></div>
							</div> <!--topic-->
							
                    		<div class="topic">
                    			<div class="cscover">
                    				<div class="cstop">
					                   <div class='inline-edit'>
					 						<div class="cstoptext" id="hidit3">Conversation Summary</div>
										</div>
                    				</div><!--cstop-->
				                    <div class="csmid">
				                    	<div class="cmmidtext">
    										<div class='inline-edit' id="summaryEdit" style="width: 100%">
												<div class="suggestxt inline_display">
													<div class="inline_full" style="display: ${convo.summary ? 'block' : 'none'}">
														<div class="inline_view" 
															style="display:block;padding-right:30px;text-align:justify">${convo.summary}</div> 
														<div class="editdiv" style="float:right;margin-right:80px;">
															<div class="editit" style="padding-top:7px;">
																<a href="#" class="inline_editlink">Edit</a>
															</div>
														</div>
													</div>
													<div class="inline_empty" style="display: ${!convo.summary ? 'block' : 'none'}">
														<div class="targetenew">
															<a class="inline_addlink" href="#">Add Conversation Summary</a>
														</div>
													</div>
									            </div>
									            <div style="margin-top:10px; margin-bottom:10px; clear: both"></div>
												<div class='inline_form'>
													<div style="float:left; width:auto;">
        												<textarea style="width:585px;height:230px;font-size:13px;font-weight:normal" 
        													id="summaryinput" class="edititinputs inline_text">${convo.summary}</textarea>
        											</div>
													<div style="float:right; width:auto;margin-right:30px;">
														<input id="summaryBtn" class="updatebtns inline_save" value=" " />
														<div class="canclebtnz">
															<a class="cancel" href="#">Cancel</a>
														</div>
													</div>
												</div>
											</div>
    										
    										#{if convo.sumContributors }
	    										<div style="clear: both; padding-top: 10px;">
	    											<span class="blacktext">Contributions By:</span> 
													<span class="blacktext">
														#{list items: convo.sumContributors, as: 'contributor'}
															#{ifnot contributor_isLast}
																<a href="#">${contributor.userName}</a>, 
															#{/ifnot}
															#{else}
																<a href="#">${contributor.userName}</a>
															#{/else}
														#{/list}
													</span>
	    										</div>
    										#{/if}
    										#{else}
    											<div style="clear: both; padding-top: 10px;">&nbsp;</div>
    										#{/else}
										</div><!--cmmidtext-->
                    				</div><!--csmid-->
                    				<div class="csbot"></div>
                    			</div>
                    		</div><!--topic-->
                    		
                     		<div class="topic" style="margin-bottom: 15px;">
                     			<a id="answers"></a>
                     			<div class="answerh1">Answers <span class="style2">(${convo.comments.size()})</span></div>
                      			<div class="topicborder"></div>
                      		</div>
                      		
                      		#{convoCommentsTree commentsList: convo.helpfulAnswers, level: 1 /}
                      		
                      		#{set notHelpfulAnswers = convo.notHelpfulAnswers /}
                      		#{if notHelpfulAnswers.size() != 0 }
                      			<a href="#" onclick="$('#notHelpfulAnswers').show(); return false;"
                      				>View ${notHelpfulAnswers.size()} Answer(s) Marked Not Helpful</a>
	                      		<div id="notHelpfulAnswers" style="display: none; margin-top: 3px;">
	                      			#{convoCommentsTree commentsList: notHelpfulAnswers, level: 1 /}
	                      		</div>	
                      		#{/if}
                      		
                        
							<div class="topic" id="replyform"><br />
								<textarea name="textarea" id="replytext" class="answerinput" 
									onclick="if (this.value === 'Add New Answer') this.value='';">Add New Answer</textarea><br />
								<input type="submit" onclick="return saveProfileComment('');" 
									src="/public/images/addcomments.jpg" class="addcomments" value=" " />
								<div class="answerh2 style1 style2">Conversation</div>
								<div class="topicborder"></div>
								
								<div class="tagtxts"><a href="#">Restart Conversation </a> |  
									<a href="#">Start Follow up conversation</a>  |  
									<a href="#" class="flagConvoLink">Flag Conversation</a> </div>
								
								<div class="talkerCover">
									<div class="talkertop">Talkers</div>
									<div class="talkermid"><br />
										#{list items: convo.members, as: 'member'}
											<img src="@{Image.show(member)}" width="48" height="48" border="0" />
											${member}&nbsp;&nbsp;&nbsp;
										#{/list}
										<!--
							              <div class="talkertxt">
							              <div class="talktextleft"><span class="uzername"><a href="#">tom:</a></span></div>
							              <div class="talktextright"><span class="uzername"><a href="#">Janifer</a></div>
							              </div>talkertxt-->
							              
										#{list items: convo.messages, as: 'message'}
											<div class="talkertxt1">
												<span class="uzername"><a href="#">${message.fromTalker.userName}:</a></span>
												&nbsp;&nbsp;${message.text} 
											</div>
										#{/list}
									</div><!--talkermid-->
									<div class="talkerbot"></div>
								</div><!--talkerCover-->
							    <div class="cb"></div>
							</div>
							<div class="cb"></div>
						</div>
						<div class="cb"></div>
					</div><!--mtcontent-->
                </div>
				<div id="mtright1" style="padding-top: 10px">
					#{if talker }
						#{if talker.followingConvosList?.contains(convo.id) }
							<a href="#" id="followConvoLink"><div class="followcnzz"></div></a>
						#{/if}
						#{else}
							<a href="#" id="followConvoLink"><div class="followcn"></div></a>
						#{/else}
					#{/if}
				    <!-- <input type="submit" class="followcn"  src="../TalkAboutHealth//public/images/followcn.jpg" value=" "  /> -->
				    <div class="cb"></div>
					<div class="topipsts">
						<div class="Statics">
							<div class="Staticsh1">Question Statistics</div>
							<p style="color:#000000">
								<strong>Latest Activity:</strong> ${latestActivityTime?.format('MM / dd / yyyy')} <br />
								<strong>Views:</strong> ${convo.views}<br />
								<strong>Followed By:</strong> ${convo.followers?.size()} members<br/>
								#{list items: convo.followers, as: 'follower'}
									<a href="@{ViewDispatcher.view(follower.userName)}" title="${follower.userName}" >
										<img src="@{Image.show(follower.userName)}" width="48" height="48" border="0" />
									</a>
								#{/list}
							</p><br />
							<div class="topicborder"></div>
						</div>
						<div class="cb"></div>
					</div><!--topipsts-->
						<div class="topipsts">
							<div class="rconversation">
								<div class='inline-edit' id="relatedConvosEdit">
									<div class="inline_display">
										<div class="inline_full" style="display: ${(convo.relatedConvos || relatedConvos) ? 'block' : 'none'}">
											<div class="Staticsh1 style1 style2" style="float:left; padding-top:10px;">
												Related Conversations</div>
											<div class="editdiv">
												<div class="editit" style="padding-top:10px;">
													<a href="#" class="inline_editlink">Edit</a>
												</div>
											</div>
											<div id="relatedConvosList">
												#{list items: convo.relatedConvos, as: 'relatedConvo'}
													<p class="rcpadtop">
														<a href="${relatedConvo.mainURL}">${relatedConvo.topic}</a>
							                		</p>
												#{/list}
											</div>
											#{list items: relatedConvos, as: 'relatedConvo'}
												<p class="rcpadtop">
													<a href="${relatedConvo.mainURL}">${relatedConvo.topic}</a>
						                		</p>
											#{/list}
										</div>
										<div class="inline_empty" style="display: ${!(convo.relatedConvos || relatedConvos) ? 'block' : 'none'}">
											<div class="targetenew">
												<a class="inline_addlink" href="#">Add Related Conversations</a>
											</div>
										</div>
						            </div>
									<div class='inline_form'>
										<div id="relatedConvosEditList">
											#{list items: convo.relatedConvos, as: 'relatedConvo'}
												<p class="rcpadtop">
													<a href="${relatedConvo.mainURL}">${relatedConvo.topic}</a>&nbsp;
													<a class="deleteConvoLink" href="#" rel="${relatedConvo.id}">X</a>
						                		</p>
											#{/list}
										</div>
										<div style="padding-top:10px;">
									        <input type="text" id="relatedConvosInput" class="edititinputx inline_text" 
									        	style="width:200px; height: 23px;" value="" />
								        </div>
										<div style="float:right; margin-right:30px;">
											<input id="detailsBtn" type="submit" class="inline_add" 
												value="Add" style="float: left;"/>
											<input id="detailsBtn" type="submit" class="cancel" 
												value="Done" style="float: left; margin-left: 10px;"/>
										</div>
									</div>
								</div>
								<!-- 
			              		<p><br />
			                      <a href="#"><strong>See More Related Conversation</strong></a> </p>
			                    -->
							</div>
							<div class="cb"></div>
						</div><!--topipsts-->
				               
                	<div class="cb"></div>
				</div>
            	<div class="cb"></div>
            </div><!--mtcover-->
            <div class="cb"></div>
		</div>
	</div>
</div>

</div>


<div id="boxes">
	<div id="dialog" class="window"></div>
	
	#{ popups/flag /}

	<div id="thankYouPopup" class="window" >
	  <div id="innermiddleareazs">
	    <div class="popboxWraper">
	      <div class="popboxflagzx1">
	        <div class="imheadingz">Give a 'Thank you' to <span id="thankYouUser"></span></div>
	        <div class="commentsCover">
	          <!--	<div class="selheadingza">&nbsp;</div>-->
	          <div class="selheadinginputs">
	            <textarea id="thankYouListNote" class="popinputs" cols="4" rows="3" style="height:50px" ></textarea>
	          </div>
	        </div>
	        <!--commentsCover-->
	        <div class="poptxtzzCover">
	          <div  class="cancs" ><a href="#" onclick="return hideAll();">Cancel</a></div>
	          <input type="submit" onclick="return saveThankYou();" value="" class="submitspopss"   src="images/submitsthanks.jpg" />
	        </div>

	        <!--poptxtCover-->
	        <div class="cb"></div>
	      </div>
	      <!--popbox-->
	    </div>
	    <!--popboxWraper-->
	    <div class="cb"></div>
	  </div>
	</div>

</div>
<!-- Mask to cover the whole screen -->
<div id="mask"></div>
