#{extends 'main.html' /}
	<style>
		body {
			background:url(/public/images/inner_bg.gif) repeat-x top;
			font-size: 14px;
		}
		#innermid {
			padding: 10px;
		}
		
		#reply {
			padding: 10px 0 0 0;
		}
		.commentsarea {
			padding-top: 0px;
		}
		#replytext {
			height: 20px;
			color: #777777;
		}
		.commentreply {
			height: 20px;
			color: #777777;
		}
	</style>

	<script type="text/javascript">
		var tid = '${convo.tid}';
		$(document).ready(function() {
			$("#followConvoLink").click(function() {
				$.post("@{Conversations.follow()}", 
	  				{ topicId: '${convo.id}'},
	  				function(data) {
	  					if ($("#followConvoLink").html() == "Follow Conversation") {
	  						$("#followConvoLink").html("Unfollow Conversation");
	  					}
	  					else {
	  						$("#followConvoLink").html("Follow Conversation");
	  					}
	  				}
	  			);
			});

			*{ TODO: convo or topic ? }*
			$(".restartConvoLink").click(function() {
				openChat(tid);
				$.post("@{Conversations.restart}", {topicId: '${convo.id}'});
			});

			$(".flagConvoLink").click(function() {
				$(this).after("<span>Thanks!</span>").detach();
				$.post("@{Conversations.flag}", {topicId: '${convo.id}'});
			});

			//comments
			$(".commentreply").each(function() {
				$(this).val("Reply to comment..").css("color", "#777777");
			});

   			$("#replytext")
	   			.click(function() {
		   			updateCommentState('Extended');
	   			})
	   			.blur(function() {
		   			if ($(this).val() == "") {
		   				updateCommentState('Initial');
		   			}
	   			});
	
	   		$(".commentreply")
	   			.click(function() {
	   				updateReplyState($(this), 'Extended');
	   			})
	   			.blur(function() {
		   			if ($(this).val() == "") {
		   				updateReplyState($(this), 'Initial');
		   			}
	   			});			
		});

		function updateCommentState(newState) {
   	   		if (newState == 'Initial') {
   	   			$("#replytext").val("What are you thinking?").css("color", "#777777");
				$("#commentBtn").hide();
   	   		}
   	   		else if (newState == 'Extended') {
	   	   		$("#replytext").val("").css("color", "#000000");
	   			$("#commentBtn").show();
   	   		}
   		}

   		function updateReplyState(replyTextArea, newState) {
   	   		if (newState == 'Initial') {
   	   			replyTextArea.val("Reply to comment..").css("color", "#777777");
   	   			replyTextArea.parent().next().hide();
   	   		}
   	   		else if (newState == 'Extended') {
   	   			replyTextArea.val("").css("color", "#000000");
	   			replyTextArea.parent().next().show();
   	   		}
   		}

   		//public static void saveTopicComment(String topicId, String parentId, String text) {
   		function saveProfileComment(parentId) {
   	   		var commentText = $("#replytext"+parentId).val();
   			$("#replytext"+parentId).val("");

   			$.post("@{Conversations.saveTopicComment()}", 
  				{ topicId: '${convo.id}', parentId: parentId, text: commentText},
  				function(html) {
  	  				$("#firstcommentmessage").hide();
  					//put comment in the tree
  					if (parentId == '') {
  	  					//add as first element in the top
  						$(html).prependTo($(".commentsarea"));
  					}
  					else {
  						//add as last element in subtree
  						$("#reply"+parentId).before($(html));
  					}
  				}
  			);

   			if (parentId == '') {
   				updateCommentState('Initial');
			}
			else {
				updateReplyState($("#replytext"+parentId), 'Initial');
			}
  			return false;
   		}

		function openChat(tid){
			window.open("@{Talk.talkApp()}/"+tid, "TalkerWindow", "width=700,height=500");
		}
	</script>
</head>

<body>
<div id="top_container">
	<div id="top">
		#{ logo /}
		<div id="topnav">
			#{include 'menu.html' /}
		</div>
	</div>
</div>

<div id="innerbanner"></div>
<div id="bottom_container">
	<div class="blacktext2" id="innerheading">${convo.topic}</div>
	<div id="middle_area_inner">
		<div id="innerboxarea">
			<div id="innerleft">
				<div id="innerlefttop"></div>
				<div id="innermid">
					${convo.details}
					<br/>
					#{list items: convo.tags, as: 'tag'}
						${tag}&nbsp;&nbsp;&nbsp;
					#{/list}
					<br/>
					#{if talker }
						<a href="#" class="restartConvoLink">Re-start conversation</a>&nbsp;
						<a href="#">Start follow up conversation</a>&nbsp;
						<a href="#" class="flagConvoLink">Flag conversation</a>&nbsp;
					#{/if}
					<br/><br/>
					<h3>Conversation Summary:</h3><br/>
					${convo.summary}<br/>
					Contributions by: 
					#{list items: convo.sumContributors, as: 'contributor'}
						${contributor}&nbsp;&nbsp;&nbsp;
					#{/list}
					<br/><br/>
					
					<div>
						<h3 id="comments">Comments:</h3><br/>

						#{if talker }
							<div id="reply" class="replyForm">
								<ul>
									<li>
										<textarea class="togglecomment" rows="1" cols="45" 
											id="replytext">What are you thinking?</textarea>
								    </li>
									<li id="commentBtn" style="display: none">
										<div style="height: 46px; padding-top: 2px;" class="personaltextarea">
											<a href="#" onclick="return saveProfileComment('');">
												<img width="145" height="32" border="0" src="/public/images/addcomment_btn.gif"/>
											</a>
										</div>
									</li> 
								</ul>
							</div>
						#{/if}
						<div class="commentsarea">
							#{topicCommentsTree commentsList: convo.comments, level: 1 /}
						</div>
					</div>

					<div style="clear: both"></div>

					<br/><br/>
					<br/><br/>
					<h3>Conversation:</h3>
					<br/>
					#{if talker }
						<a href="#" class="restartConvoLink">Re-start conversation</a>&nbsp;
						<a href="#">Start follow up conversation</a>&nbsp;
					#{/if}
					<br/>
					${convo.creationDate?.format('M/d/yyyy')}
					<br/>
					Talkers:
					#{list items: convo.members, as: 'member'}
						<img src="@{Image.show(member)}" width="48" height="48" border="0" />
						${member}&nbsp;&nbsp;&nbsp;
					#{/list}
					<br/><br/>
					#{list items: convo.messages, as: 'message'}
						${message.fromTalker.userName}: ${message.text}<br/>
					#{/list}
				</div>
				<div id="innerbot"></div>
			</div>
			<div id="innerright">
				<!-- 
				<div id="searcharea">
					<input name="" type="text" class="search"  value="Search Conversation" 
						onclick="this.value=''" onblur="this.value='Search Conversation'"/>
				</div>
				<div id="searchright"><img src="/public/images/searchbutton.gif" width="34" height="35" /></div>
				-->
				#{if talker }
				<div class="innerrightbox" style="padding-top: 0px">
					<div class="innerrightop"></div>
					<div class="innerrighmid">
						#{if talker.followingConvosList?.contains(convo.id) }
							<a href="#" id="followConvoLink">Unfollow Conversation</a>
						#{/if}
						#{else}
							<a href="#" id="followConvoLink">Follow Conversation</a>
						#{/else}
					</div>
					<div class="innerrighbot"></div>
				</div>
				#{/if}
				<div class="innerrightbox">
					<div class="innerrightop"></div>
					<div class="innerrighmid">
						<b>Question Statistics</b><br/>
						Latest Activity: <br/>
						Views: ${convo.views}<br/>
						Followed by ${convo.followers?.size()} members<br/>
						#{list items: convo.followers, as: 'follower'}
							<a href="@{ViewDispatcher.view(follower.userName)}" title="${follower.userName}" >
								<img src="@{Image.show(follower.userName)}" width="48" height="48" border="0" />
							</a>
						#{/list}
					</div>
					<div class="innerrighbot"></div>
				</div>
			</div>
		</div>
	</div>
</div>