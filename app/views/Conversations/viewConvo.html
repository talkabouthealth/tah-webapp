#{set pageType = 'Conversation' /}
#{set pageTitle = convo.topic /}
#{set pageDescription = convo.pageDescription /}
#{set pageKeywords = convo.pageKeywords /}

#{extends 'main.html' /}

	<style>
		body {
			font-size: 14px;
		}
		#innermiddlearea { padding-top: 10px }
		
		.inline_full .deleteConvoLink { display: none; }
		.topicTitle { margin-left: 10px; }
		.deleteTopicLink { margin-right: 10px }
		#topicsList, #topicsEditList { float: left }
		#topicsList .deleteTopicLink { display: none; }
		
		/* Convo title and description */
		h1 {
			color:#000000;
			font-family:arial;
			font-size:20px;
			text-decoration:none;
		}
		h2 {
			color:#4B4B4B;
			font-family:Arial;
			font-size:14px;
			font-weight: normal;
		}
		
		/* for popups */
		.popboxflagzx { top: 0px; left: 0px }
	</style>

	<script type="text/javascript" src="/public/plugins/jquery.inline-edit.js" ></script>
	<script type="text/javascript">
		var tid = "${convo.tid}";
		var currentConvoId = "${convo.id}";

		$(document).ready(function() {
			var share = "${params.share}";
			if (share === "twitter") {
				showPopup("#shareTwitterDialog", 350);
			}
			else if (share === "facebook") {
				showPopup("#shareFBDialog", 450);
			}
			
			$("#followConvoBtn").click(function() {
				//replace More button with loading image
				var moreBtn = this;
				$("#ajaxLoading").appendTo(moreBtn.parentNode).show();
				moreBtn.style.display='none';
			
				$.post("@{Conversations.follow()}", 
	  				{ convoId: '${convo.id}'},
	  				function(nextAction) {
		  				if (nextAction === "follow") {
		  					$("#followConvoBtn").removeClass().addClass("followConvoBtn");
		  					$("#ajaxLoading").hide();
		  					$("#followConvoBtn").show();
		  				}
		  				else {
		  					$("#followConvoBtn").removeClass().addClass("followingConvoBtn");
		  					$("#ajaxLoading").hide();
		  					$("#followConvoBtn").show();
		  				}
	  				}
	  			);
			});
			$(".restartConvoLink").click(function() {
				openChat(tid);
				$.post("@{Conversations.restart}", {convoId: '${convo.id}'});
			});
			$(".flagConvoLink").click(function() {
				flagType = "convo";
				flagId = '${convo.id}';
				showPopup("#flagPopup", 200);
			});

			//----- Answers ------
			//Vote Up/Vote Down handler
			$(".votebtnup, .votebtndown").live("click", function() {
   				var value = $(this).hasClass("votebtnup") ? true : false;
   				var answerId = $(this).attr("rel");

   				$.post("@{Conversations.vote}", 
   		   				{ answerId : answerId, up : value },
   		   				function(data) {
	   		   				if (data !== "Error") {
		   		   				if (value) {
		   			   				$("#vote"+answerId+" .votebtnup").addClass("selected");
		   			   				$("#vote"+answerId+" .votebtndown").removeClass("selected");
		   		   				}
		   		   				else {
		   		   					$("#vote"+answerId+" .votebtnup").removeClass("selected");
		   			   				$("#vote"+answerId+" .votebtndown").addClass("selected");
		   		   				}
		   		   				$("#comment"+answerId+" .votestxt3").html(data);
	   		   				}
   		   				}
	   				);

   				return false;
   			});
   			
			$(".flagAnswerLink").live("click", function() {
				flagType = "answer";
				flagId = $(this).attr("rel");
				showPopup("#flagPopup", 200);
			});

			//Delete topic from topics (tags)
   			$(".deleteTopicLink").live("click", function() {
   	   			$(this).prev().remove();
   	   			var topicId = $(this).attr("rel");
   	   			$(this).remove();

   	   			$.post("@{Conversations.updateField()}", 
	   					{ convoId : '${convo.id}', name: 'topic', value: topicId, todo: 'remove'},
	   					function() {
	   						$("#topicsList").html($("#topicsEditList").html());
	   					}
	   				);

   	   			return false;
   			});

			//Delete conversation from Related/Follow-Up conversations
   			$(".deleteConvoLink").live("click", function() {
   				var deleteConvoId = $(this).attr("rel");
   	   			$(this).parent().remove();

   	   			var name = "";
   	   			if ($(this).hasClass("relatedConvos")) {
   	   				name = "relatedConvos";
   	   			}
   	   			else {
   	   	   			name = "followupConvos";
   	   			}

   	   			$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: name, value: deleteConvoId, todo: 'remove'},
   					function(html) {
   						if (name === "relatedConvos") {
   							$("#relatedConvosList").html($("#relatedConvosEditList").html());
   		   	   			}
   		   	   			else {
   		   	   				$("#followupConvosList").html($("#followupConvosEditList").html());
   		   	   			}
   					}
   				);
   				
   				return false;
   			});

   			$("#mergeConvosBtn").click(function() {
   	   			if (selectedConvoURL) {
   	   				var confirmMerge = confirm("Are you sure you want to merge the following question: "+selectedConvoURL);
		   	   		if (confirmMerge) {
		   	   			showStatus("Merging...");
					
		   	   	  		$.post("@{Conversations.mergeConvos()}", 
		    				{ convoId : '${convo.id}', convoToMergeURL : selectedConvoURL},
		    				function(html) {
		    					window.location.reload();
		    				}
		    			);
		   	   		}
   	   			}
   	   			else {
   	   	   			alert("Please select correct conversation");
   	   			}
				return false;
			});

   			$("#postFollowupLink").click(function() {
				return showStartConvoDialog("question");
			});

   			$('.inline-edit').inlineEdit(
		  		{ hover: '', saveFunction: saveData, updateFunction: updateData}
		  	);

   			makeTopicsAutocomplete("#topicInput");
   			makeAutocomplete("#relatedConvosInput", "convoedit");
   			makeAutocomplete("#followupConvosInput", "convoedit");
   			makeAutocomplete("#convoToMerge", "convoedit");
		});

		/**
		* Called after inline editing of title/details/summary/etc.
		*/
		function saveData(dataType, newValue) {
			if (dataType === 'titleEdit') {
				$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'title', value: newValue},
   					function() {}
   				);
			}
			else if (dataType === 'detailsEdit') {
				$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'details', value: newValue},
   					function() {}
   				);
			}
			else if (dataType === 'summaryEdit') {
				$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'summary', value: newValue},
   					function() {}
   				);
			}
			else if (dataType.indexOf('answerEdit') == 0) {
				var answerId = dataType.substring(10);
				
	   	   		$.post("@{Conversations.updateAnswer()}", 
	  				{ answerId: answerId, todo: 'update', newText: newValue},
	  				function(html) {}
	  			);
			}
		}

		/**
		* Called after editing lists - topics, related/follow-up conversations
		*/
		function updateData(dataType, newValue) {
			if (dataType === 'relatedConvosEdit') {
				$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'relatedConvos', value: newValue, todo: 'add'},
   					function(html) {
   	   					$(html).appendTo($("#relatedConvosEditList"));

   	   					$("#relatedConvosList").html($("#relatedConvosEditList").html());
   					}
   				);
			}
			else if (dataType === 'followupConvosEdit') {
				$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'followupConvos', value: newValue, todo: 'add'},
   					function(html) {
   	   					$(html).appendTo($("#followupConvosEditList"));

   	   					$("#followupConvosList").html($("#followupConvosEditList").html());
   					}
   				);
			}
			else if (dataType === 'topicsEdit') {
				//possible comma-separated topics
				$.post("@{Conversations.updateField()}", 
   					{ convoId : '${convo.id}', name: 'topic', value: newValue, todo: 'add'},
   					function(html) {
   						$(html).appendTo($("#topicsEditList"));

   	   					$("#topicsList").html($("#topicsEditList").html());
   					}
   				);
			}
		}

   		//public static void saveAnswerOrReply(String topicId, String parentId, String text) {
   		function saveAnswerOrReply(parentId) {
   	   		var commentText = $("#replytext"+parentId).val();
   			$("#replytext"+parentId).val("");
   			$("#saveAnswerImage"+parentId).show();
   			//commentText = linkify(commentText);

   			$.post("@{Conversations.saveAnswerOrReply()}", 
  				{ convoId: '${convo.id}', parentId: parentId, text: commentText},
  				function(html) {
  					$("#replyform"+parentId).before($(html));
  					$("#saveAnswerImage"+parentId).hide();

  					//user can post only one answer per convo
  					if (parentId === '') {
  						$("#answerBtn").hide();
  	  					$("#answerFormDiv").hide();
  	  					$("#noAnswerText").show();
  					}

  					$('.inline-edit').inlineEdit(
				  		{ hover: '', saveFunction: saveData, updateFunction: updateData}
				  	);
  				}
  			);
  			return false;
   		}

   		function saveAnswer(parentId) {
   	   		var commentText = $("#replytextPopup"+parentId).val();
   			$("#saveAnswerImagePopup"+parentId).show();
   			
   			$.post("@{Conversations.saveAnswerOrReply()}", 
  				{ convoId: '${convo.id}', parentId: parentId, text: commentText},
  				function(html) {
  					hideAll();
  					$("#replyform"+parentId).before($(html));
  					$("#saveAnswerImagePopup"+parentId).hide();

  					//user can post only one answer per convo
  					if (parentId === '') {
  						$("#answerBtn").hide();
  	  					$("#answerFormDiv").hide();
  	  					$("#noAnswerText").show();
  					}

  					$('.inline-edit').inlineEdit(
				  		{ hover: '', saveFunction: saveData, updateFunction: updateData}
				  	);
  				}
  			);
  			return false;
   		}
   		function deleteAnswer(answerId) {
   	   		var confirmDel = confirm("Are you sure want to delete this answer/reply?");
   	   		if (confirmDel) {
   	   	   		$("#comment"+answerId).remove();

   	   	  		$.post("@{Conversations.updateAnswer()}", 
    				{ answerId: answerId, todo: 'delete', newText: ''},
    				function(html) {
    	  				//...
    				}
    			);
   	   		}
   	   		return false;
   		}

   		function markNotHelpful(answerId) {
   	   		var confirmDel = confirm("Are you sure you want to mark this answer as 'Not Helpful?'");
   	   		if (confirmDel) {
   	   	  		$.post("@{Conversations.updateAnswer()}", 
    				{ answerId: answerId, todo: 'setNotHelpful', newText: ''},
    				function(html) {
    	  				//...
    				}
    			);
   	   		}
   	   		return false;
   		}

   		function deleteConvo() {
   	   		var confirmDel = confirm("Are you sure want to delete this conversation?");
   	   		if (confirmDel) {
   	   	  		$.post("@{Conversations.delete()}", 
    				{ convoId : '${convo.id}'},
    				function (html) {
    					document.location = "/home";
    				}
    			);
   	   		}
   	   		
   	   		return false;
   		}

   		//------------ Convo replies ---------------
   		function saveConvoReply() {
   	   		var replyText = $("#convoReplyText").val();
   	   		$("#convoReplyText").val("");
   			$("#saveConvoReplyImage").show();

   			$.post("@{Conversations.saveConvoReply()}", 
  				{ convoId: '${convo.id}', text: replyText},
  				function(html) {
  					$("#convoReplyForm").before($(html));
  					$("#saveConvoReplyImage").hide();

  					$('.inline-edit').inlineEdit(
				  		{ hover: '', saveFunction: saveData, updateFunction: updateData}
				  	);
  				}
  			);
  			return false;
   		}

   		//used by admin
   		function deleteChatMessage(index) {
   	   		var confirmDel = confirm("Are you sure want to delete this message?");
   	   		if (confirmDel) {
   	   	   		$("#chatMessage"+index).remove();

	   	   	  	$.post("@{Conversations.deleteChatMessage()}", 
	  				{ convoId : '${convo.id}', index: index},
	  				function (html) {
	  					//...
	  				}
	  			);
	   		}
	   		
   	   		return false;
   		}

   		function addAnswer(){
   	   		showPopup("#addAnswer", 350);
   		}
	</script>
</head>

<body>
<div id="managtopic1">
<div id="managtopic">

	#{include 'header.html' /}
	<div id="bottom_container">
      	<div class="haderbanner"><div id="innerbanner"></div></div>
	<div id="targetedtherapy">
		<div id="innermiddlearea">
			<div id="mtcover">
				<div id="mtleft">
					<div class="mtcontent">
						<div id="targetedtherapy">
							<div class="suggescover">
							
#{if talker && !talker?.hiddenHelps?.contains('convo')}
<div id="convoHelp" class="helpInfo">
      <div class="popboxWraper">
        <div class="popbox2" style="width: 600px;">
          <div class="closecover" style="clear: none; float: right;">
            <div class="close" onclick="return hideHelpInfo('convo', true);"><img src="/public/images/close.jpg" alt="Close" /></div>
          </div>
          <div class="note">
		  	<strong>Help: <a href="@{ViewDispatcher.view('what-can-i-do-on-the-question-page')}"
		  		>What can I do on the Question page?</a></strong>
		  	<br/><br/>
          </div>
          <div class="cb"></div>
        </div>
      </div>
      <div class="cb"></div>
</div> 
#{/if}								
							
								<div class="editsWraper">
									<div class="editsWraper">
										<div class='inline-edit' id="titleEdit">
											<div class="inline_display">
												<div class="inline_full">
													<div class="targetedh7">
														<h1 class="inline_view" style="display: inline;">${convo.topic}</h1>
														#{if talker && (talker.admin || talker.userName == convo.talker.userName) }
															<span class="editit2" style="float: none;">
																<a href="#" class="inline_editlink">Edit</a>
															</span>
														#{/if}
													</div>
												</div>
												<div class="inline_empty" style="display: none">
													#{if talker }
													<div class="targetenew">
														<a class="inline_addlink" href="#">Add title..</a>
													</div>
													#{/if}
												</div>
								            </div>
											<div class='inline_form'>
												<div style="float:left; width:auto; padding-bottom:5px;" >
										        	<input id="titleinput" type="text" style="width:600px"  
										        		value="${convo.topic}" class="edititinputs inline_text notempty" 
										        		maxlength="160" >
										        </div>
												<div style="float:right;margin-right:30px;">
											        <input id="titleBtn" type="submit" class="updatebtns inline_save" value=" " />
											        <div class="canclebtnz">
											        	<a class="cancel" href="#">Cancel</a>
											        </div>
												</div>
											</div>
										</div>
									</div>
								</div><!--editsWraper-->
								<div style="clear:both">
									<div class='inline-edit' id="detailsEdit">
										<div class="suggestxt inline_display">
											<div class="inline_full" style="display: ${convo.details ? 'block' : 'none'}">
												<h2 class="inline_view" style="display: inline;">${convo.details?.nl2br()}</h2>
												#{if talker && (talker.admin || talker.userName == convo.talker.userName) }
													<span class="editit2" style="float: none;">
														<a href="#" class="inline_editlink">Edit</a>
													</span>
												#{/if}
											</div>
											<div class="inline_empty" style="display: ${!convo.details ? 'block' : 'none'}">
												#{if talker && (talker.admin || talker.userName == convo.talker.userName) }
													<div class="targetenew">
														<a class="inline_addlink" 
															href="#">Add Question Details (Context or Background Info)</a>
													</div>
												#{/if}
											</div>
							            </div>
										<div class='inline_form'>
											<div style="padding-top:10px;">
										        <textarea id="detailsinput" class="edititinputx inline_text" 
										        	style="width:600px">${convo.details}</textarea>
									        </div>
											<div style="float:right;margin-right:30px;">
												<input id="detailsBtn" type="submit" class="updatebtns inline_save" value=" " />
												<div class="canclebtnz">
													<a class="cancel" href="#">Cancel</a>
												</div>
											</div>
										</div>
									</div>
								</div> <!--Blank-->   
							</div><!--suggescover-->
                  		</div> <!--targetedtherapy-->
                  		<div class="topipcWraper">
                    		<div class="topic">
                    		
								<div class='inline-edit' id="topicsEdit">
									<div class="suggestxt inline_display">
										<div class="inline_full" style="display: ${convo.topics ? 'block' : 'none'}">
											<div style="display: block; float: left; width: auto;" class="topictxt">
                        						<div style="float: left;">Topics (Tags): </div>
                        						<div id="topicsList">
	                        						#{list items: convo.topics, as: 'tag'}
														<a class="topicTitle" href="@{ViewDispatcher.view(tag.mainURL)}">${tag.title}</a>
													#{/list}
                        						</div>
											</div>
											#{if talker && (talker.admin || talker.userName == convo.talker.userName) }
												<div class="editdiv">
													<div class="editit" style="padding-top:10px;">
														<a href="#" class="inline_editlink">Edit</a>
													</div>
												</div>
											#{/if}
										</div>
										<div class="inline_empty" style="display: ${!convo.topics ? 'block' : 'none'}">
											#{if talker }
												<div class="targetenew">
													<a class="inline_addlink" href="#">Add Topics</a>
												</div>
											#{/if}
										</div>
						            </div>
									<div class='inline_form'>
										<div style="display: block; float: left; width: auto;" class="topictxt">
                       						<div style="float: left;">Topics: </div>
                       						<div id="topicsEditList">
                        						#{list items: convo.topics, as: 'tag'}
													<a class="topicTitle" href="@{ViewDispatcher.view(tag.mainURL)}">${tag.title}</a>
													<a class="deleteTopicLink" href="#" rel="${tag.id}">X</a>
												#{/list}
                       						</div>
										</div>
										<div class="addcomCover" style="width:400px;">
											<input type="text" id="topicInput" 
												class="addcominput inline_text"  value="" style="float:left; width:215px;"/>
						                   	<input type="submit" value=" " id="addTopicBtn" 
						                   		class="addcomsubmit inline_add" style="float:left; width:80;"  />
									        <div class="canclebtnz" style="float:left; width:auto;">
									          	<a class="cancel" href="#">Done</a>
									        </div> 
									    </div>
									</div>
								</div>

                      
                      			#{if talker }
									<div class="tagtxts">
										<!-- REFACTOR REMOVE LIVE CHAT OPTION
				                    	<a href="#" class="restartConvoLink">Re-start chat</a> |
				                    	-->  
				                    	<a href="#" id="postFollowupLink">Post follow-up question</a> |  
				                    	
				                    	<a href="#" onclick="$('#convoreplies').toggle(); return false;"
		                        			#{if convo.replies.size() == 0}
		                        				>Reply</a>
		                        			#{/if}
			                        		#{elseif convo.replies.size() == 1}
			                        			>1 Reply</a>
			                        		#{/elseif}
			                        		#{else}
			                        			>${convo.replies.size()} Replies</a>
			                        		#{/else}		                        		
		                        		
				                    	 | <a href="#" class="flagConvoLink">Flag As Inappropriate</a> 
				                    	#{if session.username?.equals("admin") || convo.talker.userName.equals(session.username)}
				                        	  |  <a href="#" onclick="return deleteConvo();">Delete</a> 
				                        #{/if}
				                    </div>
								#{/if}
								#{else}
									<div class="tagtxts">
				                    	<a href="#" onclick="$('#convoreplies').toggle(); return false;"
		                        			#{if convo.replies.size() == 0}
		                        				></a>
		                        			#{/if}
			                        		#{elseif convo.replies.size() == 1}
			                        			>1 Reply</a>
			                        		#{/elseif}
			                        		#{else}
			                        			>${convo.replies.size()} Replies</a>
			                        		#{/else}		                        		
				                    </div>
								#{/else}
								
								<div id="convoreplies" class="replysub" style="display: none;">
									#{list items: convo.replies, as: 'convoReply'}
										#{convo/convoReply reply: convoReply, talker: talker /}
									#{/list}
									
									#{if talker}
										<div id="convoReplyForm" style="clear:both">
											<div id="saveConvoReplyImage" class="ajaxLoading" ></div>
						                    <div class="repcommbox22">
							                    <textarea id="convoReplyText" class="repcominput" ></textarea>
							                    <div class="repcommstextbox">
							                    	<input type="submit" class="repcomsubmits" 
							                    		onclick="return saveConvoReply();"
							                    		value=" " />
							                     	<span class="canclelz">
							                     		<a href="#" onclick="$('#convoreplies').hide(); return false;">Cancel</a>
							                     	</span>
							                    </div>
							                    <div class="cb"></div>
						                    </div>
					                    </div><!--Blankdivsub-->
									#{/if}
								</div>
								
								<div class="cb"></div>
							</div> <!--topic-->
							

                    		<div class="topicborder" style="margin-bottom: 5px;margin-top: 5px;"></div>
 		#{include 'socialNetworkShare.html' /}
							<div class="topicborder" style="margin-top: 10px;"></div>
                    		<div class="topicborder" style="margin-bottom: 5px;"></div>

							
							#{if convo.helpfulAnswers?.size > 1}
                    		<div class="topic inline-edit" id="summaryEdit">
                    			<div class="inline_display">
                    				<div class="inline_empty" style="display: ${!convo.summary ? 'block' : 'none'}">
                    					#{if talker }
											<div class="targetenew" style="margin-top: 10px;">
												<a class="inline_addlink" href="#">Add Answer Summary</a>
											</div>
										#{/if}
									</div>
	                    			<div class="cscover inline_full" style="display: ${convo.summary ? 'block' : 'none'}">
	                    				<div class="cstop">
						                   <div>
						 						<div class="cstoptext" id="hidit3">Answer Summary</div>
											</div>
	                    				</div><!--cstop-->
					                    <div class="csmid">
					                    	<div class="cmmidtext">
	    										<div style="width: 100%">
													<div class="suggestxt">
														<div class="inline_view" 
															style="display:block;padding-right:30px;text-align:justify">${convo.summary}</div> 
														#{if talker }
															<div class="editdiv" style="float:right;margin-right:80px;">
																<div class="editit" style="padding-top:7px;">
																	<a href="#" class="inline_editlink">Edit</a>
																</div>
															</div>
														#{/if}
										            </div>
										            <div style="margin-top:10px; margin-bottom:10px; clear: both"></div>
												</div>
	    										
	    										#{if convo.sumContributors && talker}
		    										<div style="clear: both; padding-top: 10px;">
		    											<span class="blacktext">Contributions By:</span> 
														<span class="blacktext">
															#{list items: convo.sumContributors, as: 'contributor'}
																#{ifnot contributor_isLast}
																	<a href="#">${contributor.userName}</a>, 
																#{/ifnot}
																#{else}
																	<a href="#">${contributor.userName}</a>
																#{/else}
															#{/list}
														</span>
		    										</div>
	    										#{/if}
	    										#{else}
	    											<div style="clear: both; padding-top: 10px;">&nbsp;</div>
	    										#{/else}
											</div><!--cmmidtext-->
	                    				</div><!--csmid-->
	                    				<div class="csbot"></div>
	                    			</div>
                    			</div>
					<div class="cscover inline_form">
	                    				<div class="cstop">
						                   <div>
						 						<div class="cstoptext" id="hidit3">Answer Summary</div>
											</div>
	                    				</div><!--cstop-->
					                    <div class="csmid">
					                    	<div class="cmmidtext">
	    										<div style="width: 100%">
													<div style="float:left; width:auto;">
        												<textarea style="width:585px;height:230px;font-size:13px;font-weight:normal" 
        													id="summaryinput" class="edititinputs inline_text">${convo.summary}</textarea>
        											</div>
													<div style="float:right; width:auto;margin-right:30px;">
														<input id="summaryBtn" class="updatebtns inline_save" value=" " />
														<div class="canclebtnz">
															<a class="cancel" href="#">Cancel</a>
														</div>
													</div>
												</div>
	    										
	    										#{if convo.sumContributors && talker }
		    										<div style="clear: both; padding-top: 10px;">
		    											<span class="blacktext">Contributions By:</span> 
														<span class="blacktext">
															#{list items: convo.sumContributors, as: 'contributor'}
																#{ifnot contributor_isLast}
																	<a href="#">${contributor.userName}</a>, 
																#{/ifnot}
																#{else}
																	<a href="#">${contributor.userName}</a>
																#{/else}
															#{/list}
														</span>
		    										</div>
	    										#{/if}
	    										#{else}
	    											<div style="clear: both; padding-top: 10px;">&nbsp;</div>
	    										#{/else}
											</div><!--cmmidtext-->
	                    				</div><!--csmid-->
	                    				<div class="csbot"></div>
	                    			</div>
                    		</div>
                    		#{/if}

                     		<div class="topic" style="margin-bottom: 15px;">
                     			<a id="answers"></a>
                     			<div class="answerh1">Answers <span class="style2">(${convo.comments.size()})</span></div>
                      			<div class="topicborder"></div>
                      		</div>
                      		
                      		#{convo/convoCommentsTree commentsList: convo.helpfulAnswers, level: 1, talker: talker /}
                      		
                      		#{set notHelpfulAnswers = convo.notHelpfulAnswers /}
                      		#{if notHelpfulAnswers.size() != 0 }
                      			<a href="#" onclick="$('#notHelpfulAnswers').show(); return false;"
                      				>View ${notHelpfulAnswers.size()} Answer(s) Marked Not Helpful</a>
	                      		<div id="notHelpfulAnswers" style="display: none; margin-top: 3px;">
	                      			#{convo/convoCommentsTree commentsList: notHelpfulAnswers, level: 1, talker: talker /}
	                      		</div>	
                      		#{/if}
                      		
                        
							<div class="topic" id="replyform"><br />
								#{if talker }
									<div id="answerFormDiv" style="display: ${userHasAnswer ? 'none' : 'block'};">
										<div class="topicborder" style="margin-top: 7px;"></div>
										<div class="answerh1">Add Answer</div>
										<textarea name="textarea" id="replytext" class="answerinput" style="width: 617px; height: 150px;"
											onclick="if (this.value === 'Add New Answer') this.value='';">Add New Answer</textarea><br />
										<input type="submit" onclick="return saveAnswerOrReply('');" 
											src="/public/images/addcomments.jpg" class="addcomments" value=" " />
										<div id="saveAnswerImage" class="ajaxLoading" 
											style="float: right; margin-right: 15px; margin-top: 20px;"></div>
									</div>
									<div id="noAnswerText" style="display: ${!userHasAnswer ? 'none' : 'block'};">
										Only one answer per conversation per user. You may edit your answer though.
									</div>
								#{/if}
								
								#{if session.username && convo.messages}
									<div class="answerh2 style1 style2">Conversation</div>
									<div class="topicborder"></div>
									
									<div class="tagtxts">
										<!-- REFACTOR REMOVE LIVE CHAT OPTION
										<a href="#" class="restartConvoLink">Re-start chat</a> |
										-->  
										<a href="#" class="flagConvoLink">Flag As Inappropriate</a>
									</div>
									
									<div class="talkerCover">
										<div class="talkertop">Talkers</div>
										<div class="talkermid">
											<div class="talkertxt1" style="padding-top: 10px;">
												#{list items: convo.members, as: 'member'}
													#{ talker/talkerImageLink userName: member, size: 48 /}
													${member}&nbsp;&nbsp;&nbsp;
												#{/list}
											</div>
											
											#{list items: convo.messages, as: 'message'}
												<div id="chatMessage${message.index}" class="talkertxt1">
													<span class="uzername">
														<a href="@{ViewDispatcher.view(message.fromTalker.userName)}"
															>${message.fromTalker.userName}</a>:
													</span>
													&nbsp;&nbsp;${message.text}
													#{if talker?.isAdmin() }
														&nbsp;&nbsp;
														<a href="#" onclick="return deleteChatMessage(${message.index});">X</a>
													#{/if}
												</div>
											#{/list}
										</div><!--talkermid-->
										<div class="talkerbot"></div>
									</div><!--talkerCover-->
								#{/if}
							    <div class="cb"></div>
							</div>
							
							
							#{if talker?.isAdmin() }
								<div class="topic">
			                      <div class="topich1">Merge conversation</div>
			                      <div class="mtinputbox" style="padding-top: 0px;">
			                        <input id="convoToMerge" type="text" onfocus="selectedConvoURL = '';"
			                        	class="mtinput" style="width: 300px; margin-right: 10px;"/>
			                        <input id="mergeConvosBtn" type="submit" value="" src="/public/images/mergebtn.jpg" class="mergebtn"/>
			                        <div class="cb"></div>
			                      </div>
			                      <!--mtinputbox-->
			                      <div class="cb"></div>
			                    </div>
							#{/if}

							#{ notLoggedNotice /}
							<span style="color: red; font-weight: bold;">
								<br/><br/>
								Note: All content on this site is informational and not a substitute for professional medical advice. 
								Always seek the advice of your physician or other qualified health provider with questions regarding your health.
							</span>
			
							<div class="cb"></div>
						</div>
						<div class="cb"></div>
					</div><!--mtcontent-->
                </div>
				<div id="mtright1" style="padding-top: 10px">
					#{if talker }
					<div width=100%>
						#{if talker.followingConvosList?.contains(convo.id) }
							<a href="#" id="followConvoBtn" class="followingConvoBtn"></a>
							<a href="#" id="answerBtn" class="answerBtn" onclick="addAnswer();" style="display: ${userHasAnswer ? 'none' : 'block'};"></a>
						#{/if}
						#{else}
							<a href="#" id="followConvoBtn" class="followConvoBtn"></a>
							<a href="#" id="answerBtn" class="answerBtn" onclick="addAnswer();" style="display: ${userHasAnswer ? 'none' : 'block'};"></a>
						#{/else}
					</div>
						<!-- REFACTOR REMOVE LIVE CHAT OPTION
						<input type="button" class="restartConvoLink restartChatBtn" value="" />
						-->
						
						<div class="cb"></div>
				    	<div class="topicborder" style="margin-top: 10px;"></div>
					#{/if}
					#{else}
						#{include 'tahInfo.html' /}
					#{/else}
				    
					<div class="topipsts">
						<div class="Statics">
							<div class="Staticsh1">Question Statistics</div>
							<p style="color:#000000">
								<strong>Latest Activity:</strong> ${latestActivityTime?.format('MM / dd / yyyy')} <br />
								<strong>Views:</strong> ${convo.views}<br />
								<strong>Followed By:</strong> ${convo.followers?.size()} members<br/>
								#{if talker}
									#{list items: convo.followers, as: 'follower'}
										#{talker/talkerImageLink size: 48, userName: follower.userName /}
									#{/list}
								#{/if}
							</p><br />
							<div class="topicborder"></div>
						</div>
						<div class="cb"></div>
					</div><!--topipsts-->
					
					<div class="topipsts">
						<div class='inline-edit' id="relatedConvosEdit" style="padding-bottom: 3px;">
							<div class="inline_display">
								<div class="Staticsh1" style="float:left; padding:10px 0 0 0;">Similar Questions</div>
								<div class="inline_full" style="display: ${(convo.relatedConvos || relatedConvos) ? 'block' : 'none'}">
									#{if talker && (talker.admin || talker.userName == convo.talker.userName) }
										<div class="editdiv">
											<div class="editit" style="padding-top:10px;">
												<a href="#" class="inline_editlink">Edit</a>
											</div>
										</div>
									#{/if}
									<div id="relatedConvosList">
										#{list items: convo.relatedConvos, as: 'relatedConvo'}
											<p class="rcpadtop">
												<a href="${relatedConvo.mainURL}">${relatedConvo.topic}</a>
					                		</p>
										#{/list}
									</div>
									#{list items: relatedConvos, as: 'relatedConvo'}
										<p class="rcpadtop">
											<a href="${relatedConvo.mainURL}">${relatedConvo.topic}</a>
				                		</p>
									#{/list}
								</div>
								<div class="inline_empty" style="display: ${!(convo.relatedConvos || relatedConvos) ? 'block' : 'none'}">
									#{if talker }
										<div class="targetenew">
											<a class="inline_addlink" href="#">Add a new similar question</a>
										</div>
									#{/if}
								</div>
				            </div>
							<div class='inline_form'>
								<div class="Staticsh1" style="float:left; padding:10px 0 0 0;">Similar Questions</div>
								<div style="float:left; font-size: 14px;">Add a similar question</div>
								<div id="relatedConvosEditList">
									#{list items: convo.relatedConvos, as: 'relatedConvo'}
										<p class="rcpadtop">
											<a href="${relatedConvo.mainURL}">${relatedConvo.topic}</a>&nbsp;
											<a class="deleteConvoLink relatedConvos" href="#" rel="${relatedConvo.id}">X</a>
				                		</p>
									#{/list}
								</div>
								<div style="float: left; padding-top:10px;">
							        <input type="text" id="relatedConvosInput" class="edititinputx inline_text" 
							        	style="width:200px; height: 22px;" value="" />
						        </div>
								<div style="float:left; width: 205px; padding-top: 5px; text-align: right;">
									<a href="#" class="cancel">Done</a>
									<input type="submit" class="inline_add" 
										value="Add" style="margin-left: 7px;" />
								</div>
							</div>
						</div>
						
						<div class="topicborder"></div>
						<div class="cb"></div>
					</div><!--topipsts-->
					
					<div class="topipsts">
						<div class="inline-edit" id="followupConvosEdit" style="padding-bottom: 3px;">
							<div class="inline_display">
								<div class="Staticsh1" style="float:left; padding:10px 0 0 0;">Follow-up Questions</div>
								<div class="inline_full" style="display: ${convo.followupConvos ? 'block' : 'none'}">
									#{if talker }
										<div class="editdiv">
											<div class="editit" style="padding-top:10px;">
												<a href="#" class="inline_editlink">Edit</a>
											</div>
										</div>
									#{/if}
									<div id="followupConvosList">
										#{list items: convo.followupConvos, as: 'followupConvo'}
											<p class="rcpadtop">
												<a href="${followupConvo.mainURL}">${followupConvo.topic}</a>
					                		</p>
										#{/list}
									</div>
								</div>
								<div class="inline_empty" style="display: ${!convo.followupConvos ? 'block' : 'none'}">
									#{if talker }
										<div class="targetenew">
											<a class="inline_addlink" href="#">Add a new follow up question</a>
										</div>
									#{/if}
								</div>
				            </div>
							<div class='inline_form'>
								<div class="Staticsh1" style="float:left; padding:10px 0 0 0;">Follow-up Questions</div>
								<div style="float:left; font-size: 14px;">Add a follow up question</div>
								<div id="followupConvosEditList">
									#{list items: convo.followupConvos, as: 'followupConvo'}
										<p class="rcpadtop">
											<a href="${followupConvo.mainURL}">${followupConvo.topic}</a>&nbsp;
											<a class="deleteConvoLink" href="#" rel="${followupConvo.id}">X</a>
				                		</p>
									#{/list}
								</div>
								<div style="float: left; padding-top:10px;">
							        <input type="text" id="followupConvosInput" class="edititinputx inline_text" 
							        	style="width:200px; height: 22px;" value="" />
						        </div>
								<div style="float:left; width: 205px; padding-top: 5px; text-align: right;">
									<a href="#" class="cancel">Done</a>
									<input type="submit" class="inline_add" 
										value="Add" style="margin-left: 7px;" />
								</div>
							</div>
						</div>
						
						<div class="topicborder"></div>
						<div class="cb"></div>
					</div><!--topipsts-->
					
					#{set currentPage = 'conversationSummary' /}
					#{include 'Upcoming_Workshops.html' /}
					#{common/popularTopics popularTopics: popularTopics /}
					#{include 'SHARE_telephone_support.html' /}
					#{include 'tahHowYouCanHelp.html' /}
					#{include 'shareWidgets.html' /}
				               
                	<div class="cb"></div>
				</div>
            	<div class="cb"></div>
            </div><!--mtcover-->
            <div class="cb"></div>
		</div>
	</div>
</div>

</div>


<div id="boxes">
	<div id="dialog" class="window"></div>
	
	#{ popups/flag /}
	#{ popups/thankyou /}
	#{ popups/addAnswer /}
	#{popups/startConvo page: "conversationSummary" /}
	
	#{if talker}
		#{set twitterAccount = talker.serviceAccountByType(models.ServiceAccountBean.ServiceType.TWITTER) /}
		
*{ 
	Tags should be in one line because of the bug:
	https://bugs.launchpad.net/play/+bug/579936
}*
		#{ popups/shareEmail shareType: 'Conversation', userName: talker?.userName, topicName: convo.topic, topicDetails: convo.summary, topicURL: currentURL /}
		#{ popups/shareTwitter shareType: 'Conversation', userName: twitterAccount?.userName, topicName: convo.topic, topicURL: convo.bitly /}
		#{ popups/shareFacebook shareType: 'Conversation', topicName: convo.topic, topicURL: currentURL /}							
	#{/if}
</div>
<div id="mask"></div>
